<html lang="tr"><head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Fenix A320 Smart Checklist</title>
<!-- iOS & PWA için -->
<link href="./manifest.json" rel="manifest">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
<meta content="A320 Checklist" name="apple-mobile-web-app-title">
<link href="icons/icon-192.png" rel="apple-touch-icon">
<link href="icons/icon-192.png" rel="icon" sizes="192x192" type="image/png">
<link href="icons/icon-512.png" rel="icon" sizes="512x512" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;family=Oswald:wght@500;700&amp;display=swap" rel="stylesheet">
<style>

/* =========================================================
   🎨 TEMA DEĞİŞKENLERİ (Dark & Light) ve TEMEL AYARLAR
   Amaç: Uygulamanın renk paleti, gölge ve radius değerleri
   ========================================================= */

/* Dark Theme (varsayılan) */
:root{
  --bg:#0f1117;              /* Sayfa arka planı */
  --panel:#1c1f26;           /* Panel/kutu arka planı */
  --item:#2a2f3a;            /* Madde arka planı */
  --item-hover:#3b4252;      /* Madde hover rengi */
  --text:#e5e7eb;            /* Genel metin rengi */
  --title:#ffb347;           /* Başlık vurgusu */
  --header:#048CFC;          /* Ana header şeridi */
  --shadow:0 4px 7px rgba(0,0,0,.2); /* Genel gölge */
  --radius-lg:16px;          /* Büyük radius */
  --radius-md:10px;          /* Orta radius */
  --accent:#60a5fa;          /* Vurgu rengi */
  --success:#22c55e;         /* Başarı/Tamamlandı */
}

/* Light Theme (Pastel / Soft) — body üzerine .light geldiğinde değişken override */
body.light {
  --bg: #f5f5f5;                         /* Açık zemin */
  --panel: #ffffff;                      /* Beyaz paneller */
  --item: #e5e7eb;                       /* Açık gri item */
  --item-hover: #d1d5db;                 /* Hover gri */
  --text: #7a7979;                       /* Koyu gri metin */
  --title: #c3c9d4;                      /* Başlık tonu */
  --header: #2a3037;                     /* Üst başlık tonu */
  --shadow: 0 4px 8px rgba(0,0,0,.06);   /* Hafif gölge */
  --accent: #72757d;                     /* Nötr vurgu */
  --success: #059669;                    /* Başarı yeşili */
}

/* ===== Light tema reset butonu daha koyu ===== */
body.light .reset{
  background:#1F2937; /* koyu gri arka plan */
  color:#fff;
}
body.light .reset:hover{
  background:#111827; /* daha koyu hover */
}


/* ---------------------------------------------------------
   📐 GENEL RESET ve GÖVDE
   Amaç: Kutulama modeli ve sayfa temel tipografi/düzeni
   --------------------------------------------------------- */
* { box-sizing: border-box; }

body{
  margin:0; 
  background:var(--bg); 
  color:var(--text);
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  text-align:center;
}

/* ---------------------------------------------------------
   🧭 GLOBAL BAŞLIK (Sayfa üst banner h3)
   Amaç: Sayfa üstündeki büyük bölüm başlığını vurgulamak
   --------------------------------------------------------- */
h3{

  font-family:Oswald, sans-serif;
  font-weight:500;
  font-size:clamp(18px, 4vw, 28px);
}

/* ---------------------------------------------------------
   📦 TOPIC KUTULARI (topic-box) ve BAŞLIKLAR
   Amaç: Her konu/grubu çevreleyen kart ve sticky başlık
   --------------------------------------------------------- */
.topic-box{
  width:min(700px, 92vw);
  margin:24px auto 40px;
  padding:16px;
  border-radius:var(--radius-lg);
  background:var(--panel);
  box-shadow:var(--shadow);
  text-align:left;
  position: relative;
}

/* Konu başlığı (sticky + tipografi) */
.topic-box h2{
  font-family: Oswald, sans-serif;
  font-weight: 600;
  letter-spacing: .3px;
  font-size:clamp(16px, 3.5vw, 24px);
  color: var(--title);
  margin: 0;
  padding: 10px 12px;
  background: transparent;
  border-radius: 0px;

  /* sticky davranış ve görsel vurgu */
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

/* Konu içi alt başlıklar */
.topic-box h3{

  font-size:clamp(14px, 3.5vw, 20px);
  color: var(--accent);
}

/* ---------------------------------------------------------
   ✅ GÖREV MADDELERİ (item) ve DURUMLAR
   Amaç: Liste maddeleri, hover, içerik hizalama, rozet alanı
   --------------------------------------------------------- */
.item{
  display:block;
  width:100%;
  padding:10px 20px;            /* Tablet dostu daha büyük */
  margin:8px 0;
  border:none;
  border-radius:var(--radius-md);
  background:var(--item);
  color:inherit;
  cursor:pointer;
  box-shadow:var(--shadow);
  text-align:left;
  position: relative;
  font-size:clamp(14px, 3.5vw, 18px);              /* Dokunmatik için daha okunaklı */
}
.item:hover{ background:var(--item-hover); }
/* Otomatik kaydırma highlight'ı */
.item.autoscroll-highlight{
  outline: 2px solid color-mix(in srgb, var(--accent) 60%, transparent);
  box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 24%, transparent), var(--shadow);
  transition: outline .2s ease, box-shadow .2s ease;
}

/* Klavye odağı görünür olsun */
.item:focus{
  outline: 2px solid var(--accent);
  box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 24%, transparent), var(--shadow);
}


/* Madde iç metin ve sağ ikon boşluğu */
.item p {
  margin:0;
  display:flex;
  align-items:center;
  gap:5px;
  line-height:1.35;
  padding-right:35px; /* sağdaki rozet ve ? için alan */
}

/* Metin ile ikon arası noktalı çizgi dolgu */
.dotfill {
  flex: 1 1 auto;
  border-bottom: 2px dotted rgba(255,255,255,.45);
  margin-left: 0;
  margin-right: 0;
  transform: translateY(-2px);
  align-self: flex-end;
}

/* Kritik ve Opsiyonel madde görünümleri */
.item.critical{
  background:#7f1d1d;
  color:#fff;
  border:2px solid #dc2626;
}
.item.optional{
  background:#f3f4f6;
  color:#4b5563;
  border:2px dashed #9ca3af;
}

/* Tamamlanan tekil madde görünümü */
.item.done{
  opacity:.6;
  position:relative;
  outline:2px solid var(--success);
  box-shadow:
    0 0 0 3px color-mix(in srgb, var(--success) 30%, transparent) inset,
    var(--shadow);
}

.item.done{
  padding-left: 36px; /* boşluk bırak */
}
.item.done::after{
  content:"✅";
  position:absolute;
  left:10px;
  top:50%;
  transform: translateY(-50%);
  font-size:18px;
}


/* ---------------------------------------------------------
   ❓ MADDE İÇİ BİLGİ BUTONU
   Amaç: Sağ taraftaki dairesel “?” butonu ve hover hali
   --------------------------------------------------------- */
.info-btn{
  position:absolute;
  right:10px;
  top:50%;
  transform: translateY(-50%);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:28px; height:28px;
  border-radius:50%;
  background:rgba(255,255,255,.08);
  border: 1px solid #4b5563;
  font-weight:700;
  font-size:14px;
  line-height:1;
  cursor:pointer;
  user-select:none;
}
.info-btn:hover{ background:rgba(255,255,255,.16); }

/* ---------------------------------------------------------
   🔄 RESET BUTONLARI
   Amaç: Listeyi/ilerlemeyi sıfırlayan butonlar
   --------------------------------------------------------- */
.reset{
  display:block;
  margin: 12px auto 0;
  text-align: center;
  font-weight: 600;
  font-size:clamp(14px, 3.5vw, 18px);
  padding: 12px 18px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:#fff;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.reset:hover{ background:#1d4ed8; }

/* Global reset tetikleyici (ID bazlı) */
#globalReset { cursor: pointer; }

/* ---------------------------------------------------------
   🏁 TAMAMLANMA DURUMU (TOPIC SEVİYESİ)
   Amaç: Bir konudaki tüm maddeler tamamlandığında başlık stili
   --------------------------------------------------------- */
.completed{
  outline:2px solid #22c55e55;
  box-shadow:0 0 0 3px #22c55e22 inset, var(--shadow);
}

/* ---------------------------------------------------------
   🪟 MODAL / AÇIKLAMA PENCERELERİ (Madde açıklamaları)
   Amaç: Overlay, kart, başlık, gövde, alt kısım ve butonlar
   --------------------------------------------------------- */

/* Genel modal örtüsü */
.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 50;
}
.modal.show{ display:flex; }

/* Modal kartı */
.modal-card{
  width:min(720px, 96vw);
  max-height: 85vh;
  overflow:auto;
  background: #0f141b;
  color: var(--text);
  border-radius: 16px;
  box-shadow: var(--shadow);
  border:1px solid rgba(255,255,255,.08);
}

/* Modal başlık çubuğu (sticky) */
.modal-header{
  /* child layout: [modal-left] [modal-actions] [close-btn] */
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: #101826;
  position: sticky;
  top:0;
}

/* Modal başlık metni */
.modal-title{
  font-family: Oswald, sans-serif;
  font-size:clamp(14px, 3.5vw, 20px);
  color: var(--title);
}

/* Modal gövde metni */
.modal-body{
  padding:16px 18px 22px;
  line-height:1.55;
  white-space: pre-wrap;
  text-align: justify;
}
.modal-body ul { list-style-type: disc; padding-left: 20px; margin: 0; }
.modal-body li { margin-bottom: 4px; }

/* Kapatma butonu (X) */
.close-btn{
  border:none;
  background:transparent;
  color:var(--text);
  font-size:22px;
  cursor:pointer;
  width:32px; height:32px;
  border-radius:8px;
}
.close-btn:hover{ background:rgba(255,255,255,.08); }

/* Left cluster in modal header: title + delete button */
.modal-left{ display:flex; align-items:center; gap:8px; }

/* Modal alt buton alanı ve kopyalama butonu */
.modal-footer{
  padding:10px 18px 16px;
  border-top:1px solid rgba(255,255,255,.08);
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
.copy-btn{
  border:none;
  border-radius:10px;
  padding:10px 14px;
  cursor:pointer;
  background: #1f2937;
  color: var(--text);
}
.copy-btn:hover{ background:#374151; }

/* ---------------------------------------------------------
   📑 DOKÜMAN BİLGİSİ POPUP (Sadece #topic1 için)
   Amaç: Sağ üst info butonu ve onun açtığı modal
   --------------------------------------------------------- */

/* Sağ üst “info” butonu — yalnızca #topic1 */
#topic1 .doc-info-btn{
  position:absolute;
  top:10px; right:12px;
  width:50px; height:32px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  z-index:2;
}
#topic1 .doc-info-btn:hover{ background:rgba(255,255,255,.12); }

/* Doküman Özellikleri popup overlay */
#docInfoModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
#docInfoModal.show{ display:flex; }

/* Doküman Özellikleri kutusu */
#docInfoModal .box{
  width:min(600px,90vw);
  background:#0f141b;
  color:var(--text);
  border-radius:12px;
  padding:20px;
  box-shadow:var(--shadow);
  text-align:justify;
}
#docInfoModal h4{ margin-top:0; color:var(--title); }
#docInfoModal .close{
  float:right;
  background:none; border:none;
  color:var(--text);
  font-size:20px;
  cursor:pointer;
}


/* ---------------------------------------------------------
   🔹 ALT LİSTELER, SÜRÜM ÇUBUĞU ve UTILITIES
   --------------------------------------------------------- */
.sub-list li{
  margin-bottom: 10px;
  font-size:clamp(12px, 3vw, 16px);
  font-weight: 400;
}

.version-bar{
  width:min(700px, 92vw);
  margin: -10px auto 14px;
  font-size: 13px;
  opacity:.9;
  color: var(--text);
}
.version-bar .sep{ margin:0 6px; opacity:.7; }
body.light .version-bar{ opacity:.95; }

/* Görünmez yardımcı sınıf */
.hidden{ display:none !important; }

/* ---------------------------------------------------------
   📱 MOBİL DÜZEN İYİLEŞTİRMELERİ
   --------------------------------------------------------- */
@media (max-width: 640px){
  .topic-box{ padding:18px; }
  .item{ margin:14px 0; padding:20px 22px; }
  .sub-list li{ margin-bottom:12px; }
  .reset{ margin-top:16px; padding:12px 18px; }
}




/* ===== Light tema ek kontrast iyileştirmeleri ===== */
body.light .info-btn{
  background: rgba(0,0,0,.08);
  border: 1px solid rgba(0,0,0,.25);
  color: #111; /* simge daha koyu */
}
body.light .info-btn:hover{
  background: rgba(0,0,0,.18);
}

body.light .sub-list li{
  color:#1F2937; /* alt liste metinleri daha koyu */
}

body.light .dotfill{
  border-bottom-color: rgba(0,0,0,.4);
}

body.light .modal-title{
  color:#1E3A8A; /* koyu mavi başlık */
}

body.light .topic-box h2{
  color:#0F172A; /* bölümler için koyu başlık */
}


/* === Actions row (Reset + Add Row) === */
.actions{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:8px;
  width:100%;
}
.actions .reset{
  margin:0;
}
.add-row{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  font-size:16px;
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.add-row:hover{ background:#15803d; }

.reset, .add-row{
  font-size:14px;
  padding:8px 14px;
  border-radius:10px;
}

/* Modal header actions */
.modal-actions .copy-btn{
  padding:8px 12px;
  font-size:14px;
}



/* === Top Controls (Theme, Save, Restore) aligned === */
#topControls{
  position: relative;
  margin: 16px auto 24px;
  display:flex;
  gap:8px;
  justify-content:center;
  align-items:center;
  z-index:10;
}
#topControls button{
  width:48px; height:48px;
  font-size:20px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.15);
  background:rgba(255,255,255,.3);
  backdrop-filter:blur(6px);
  cursor:pointer;
  transition:all .2s ease;
}
#topControls button:hover{
  background:rgba(255,255,255,.6);
  transform:scale(1.05);
}


#infoModal .modal-body{ line-height:1.2; }
#infoModal .modal-body ul{ padding-left: 20px; margin: 0; }
#infoModal .modal-body li{ margin-bottom:0; }


/* === Responsive modal & buttons & icons === */
.modal-title {
  font-size: clamp(14px, 3.5vw, 20px);
}
.modal-body {
  font-size: clamp(12px, 3.5vw, 16px);
  line-height: 1.4;
}
.modal-body li {
  font-size: clamp(12px, 3.5vw, 15px);
}
.copy-btn {
  font-size: clamp(12px, 3vw, 14px);
  padding: clamp(6px, 2vw, 10px) clamp(10px, 3vw, 14px);
}
.close-btn {
  font-size: clamp(18px, 5vw, 22px);
  width: clamp(24px, 7vw, 32px);
  height: clamp(24px, 7vw, 32px);
}
.info-btn {
  width: clamp(20px, 7vw, 28px);
  height: clamp(20px, 7vw, 28px);
  font-size: clamp(12px, 4vw, 14px);
}


/* === Prevent wrapping and auto-shrink text === */
.topic-box h2 {
  white-space: nowrap;
  text-overflow: clip;
  overflow: hidden;
  font-size: clamp(12px, 4vw, 22px);
}

.item p {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: clamp(12px, 3vw, 18px);
}


#topic1.completed h2 {
  color: var(--success);
}
#topic1.completed h2::after {
  content: "SET";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === EFB INITIALIZATION tamamlandığında başlık yeşil ve SET (kutusuz, minimum boşluk) === */
#topic2.completed h2 {
  color: var(--success);
}
#topic2.completed h2::after {
  content: "SET";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic3 badge === */
#topic3.completed h2 {
  color: var(--success);
}
#topic3.completed h2::after {
  content: "COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic4 badge === */
#topic4.completed h2 {
  color: var(--success);
}
#topic4.completed h2::after {
  content: "COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic5 badge === */
#topic5.completed h2 {
  color: var(--success);
}
#topic5.completed h2::after {
  content: "COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic6 badge === */
#topic6.completed h2 {
  color: var(--success);
}
#topic6.completed h2::after {
  content: "OBTAIN";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic7 badge === */
#topic7.completed h2 {
  color: var(--success);
}
#topic7.completed h2::after {
  content: "COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic8 badge === */
#topic8.completed h2 {
  color: var(--success);
}
#topic8.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic9 badge === */
#topic9.completed h2 {
  color: var(--success);
}
#topic9.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic10 badge === */
#topic10.completed h2 {
  color: var(--success);
}
#topic10.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic11 badge === */
#topic11.completed h2 {
  color: var(--success);
}
#topic11.completed h2::after {
  content: "SET";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic12 badge === */
#topic12.completed h2 {
  color: var(--success);
}
#topic12.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic13 badge === */
#topic13.completed h2 {
  color: var(--success);
}
#topic13.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic14 badge === */
#topic14.completed h2 {
  color: var(--success);
}
#topic14.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic15 badge === */
#topic15.completed h2 {
  color: var(--success);
}
#topic15.completed h2::after {
  content: "CHECKLIST COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


/* === topic16 badge === */
#topic16.completed h2 {
  color: var(--success);
}
#topic16.completed h2::after {
  content: "COMPLETED";
  font-family: inherit;
  font-weight: inherit;
  margin-left: 2px;
  color: var(--success);
  font-size: inherit;
}


@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-6px); }
  100% { transform: translateX(0); }
}
.topic-box.shake {
  animation: shake 0.4s ease;
}

</style><style>
/* === HARD NAV (guaranteed visible) === */
#__hardMainNav{
  width: min(700px, 92vw) !important;
  margin: 10px auto 20px !important;
  display: flex !important;
  justify-content: center !important;
  gap: 10px !important;
  z-index: 50 !important;
}
#__hardMainNav .__tab{
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 140px !important;
  padding: 10px 14px !important;
  border-radius: var(--radius-lg) !important;
  text-decoration: none !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  line-height: 1 !important;
  background: #007bff !important;
  color: #fff !important;
  box-shadow: var(--shadow) !important;
}
#__hardMainNav .__tab.__active{ background:#005ec0 !important; }
#__hardMainNav .__tab:hover{ filter: brightness(1.05) !important; }
</style><style>
/* === HARD NAV under title bar === */
#__hardMainNav{
  width: min(700px, 92vw) !important;
  margin: 10px auto 20px !important;
  display: flex !important;
  justify-content: center !important;
  gap: 10px !important;
  z-index: 50 !important;
}
#__hardMainNav .__tab{
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 140px !important;
  padding: 10px 14px !important;
  border-radius: var(--radius-lg) !important;
  text-decoration: none !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  line-height: 1 !important;
  background: #007bff !important;
  color: #fff !important;
  box-shadow: var(--shadow) !important;
}
#__hardMainNav .__tab.__active{ background:#005ec0 !important; }
#__hardMainNav .__tab:hover{ filter: brightness(1.05) !important; }
</style><style>
/* === Fix overlapping/double blue bar on the top title === */
#globalResetWrap{
  display:block !important;
  text-align:center !important;
  width:min(700px, 92vw) !important;
  margin:24px auto 10px !important;
  padding:10px 16px !important;
  border-radius:var(--radius-lg) !important;
  background:#007bff !important;
  color:#fff !important;
  box-shadow:var(--shadow) !important;
}
#globalReset{
  background:transparent !important;
  box-shadow:none !important;
  border:0 !important;
  outline:0 !important;
  padding:0 !important;
  margin:0 !important;
  display:inline !important;
  position:static !important;
  color:#fff !important;
}
/* Pen exactly next to text, no frame */
#globalResetWrap .title-edit-btn{
  width:18px !important; height:18px !important;
  font-size:11px !important;
  border:none !important; background:transparent !important; box-shadow:none !important;
  margin-left:6px !important; padding:0 !important;
  vertical-align:middle;
}
</style><style>
/* === FINAL OVERRIDE: kill any inner bar styles on #globalReset === */
#globalReset{
  background: transparent !important;
  box-shadow: none !important;
  border: 0 !important;
  outline: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  width: auto !important;
  border-radius: 0 !important;
  display: inline !important;
  position: static !important;
  filter: none !important;
}
</style><style>
/* final single bar guarantee */
#globalReset{background:transparent!important;box-shadow:none!important;border:0!important;outline:0!important;padding:0!important;margin:0!important;width:auto!important;border-radius:0!important;display:inline!important;position:static!important;filter:none!important}
</style><style>
/* === Single, clean title bar === */
#topTitleBar{
  width: min(700px, 92vw);
  margin: 24px auto 10px;
  padding: 10px 16px;
  border-radius: var(--radius-lg);
  background: #007bff;
  color: #fff;
  box-shadow: var(--shadow);
  text-align: center;
}
#topTitleBar #globalReset{
  display: inline;
  background: transparent;
  box-shadow: none;
  border: 0;
  outline: 0;
  padding: 0;
  margin: 0;
  color: #fff;
}
#topTitleBar .title-edit-btn{
  margin-left: 6px;
  width: 18px;
  height: 18px;
  font-size: 11px;
  border: none;
  background: transparent;
  box-shadow: none;
  color: #fff;
  vertical-align: middle;
}

/* Neutralize any old wrap styles (if remains from cache fragments) */
#globalResetWrap{ background: transparent !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
</style><style>
/* === Center topic-box headings === */
.topic-box > h2{
  text-align: center !important;
  width: 100% !important;
  display: block !important;
}
.topic-box > .title-edit-wrap{
  width: 100% !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
}
.topic-box > .title-edit-wrap h2{
  margin: 0 !important;
  text-align: center !important;
}
</style>
<style>
/* === Remove auto labels like SET / COMPLETED appended to topic headers === */
[id^="topic"].completed h1::after,
[id^="topic"].completed h2::after,
[id^="topic"].completed .title-edit-wrap::after{
  content: '' !important;
  margin: 0 !important;
}

/* === Hide pencil icon in completed sections === */
[id^="topic"].completed .title-edit-btn{
  display: none !important;
}
</style>
<style>
/* === Shift completed (green) topic headers slightly right === */
[id^="topic"].completed h1,
[id^="topic"].completed h2{
  text-align: center !important;
  padding-left: 30px !important; /* add space on left to push right */
  box-sizing: border-box;
}
</style>
<style>
/* === Aviation-themed nav colors === */
#mainNav .mainBtn:nth-child(1) {
  background: #007bff !important; /* VATSIM */
}
#mainNav .mainBtn:nth-child(2) {
  background: #fd7e14 !important; /* PRELIM */
}
#mainNav .mainBtn:nth-child(3) {
  background: #28a745 !important; /* NORMAL */
}

#mainNav .mainBtn:nth-child(1):hover { background: #0069d9 !important; }
#mainNav .mainBtn:nth-child(2):hover { background: #e8590c !important; }
#mainNav .mainBtn:nth-child(3):hover { background: #218838 !important; }

#mainNav .mainBtn.active {
  filter: brightness(0.9);
}
</style>
<style>
/* === Aviation-themed nav colors for __hardMainNav/__tab structure === */
#__hardMainNav .__tab:nth-child(1) { background: #007bff !important; } /* VATSIM */
#__hardMainNav .__tab:nth-child(2) { background: #fd7e14 !important; } /* PRELIM */
#__hardMainNav .__tab:nth-child(3) { background: #28a745 !important; } /* NORMAL */

#__hardMainNav .__tab:nth-child(1):hover { background: #0069d9 !important; }
#__hardMainNav .__tab:nth-child(2):hover { background: #e8590c !important; }
#__hardMainNav .__tab:nth-child(3):hover { background: #218838 !important; }

#__hardMainNav .__tab.__active { filter: brightness(0.9) !important; }
</style>
<style>
/* === Theme 3: Cockpit Deep (deep tones, high contrast) === */
#__hardMainNav .__tab:nth-child(1){ background:#1f3b73 !important; } /* VATSIM: deep navy */
#__hardMainNav .__tab:nth-child(2){ background:#b35400 !important; } /* PRELIM: burnt orange */
#__hardMainNav .__tab:nth-child(3){ background:#157347 !important; } /* NORMAL: deep green */

#__hardMainNav .__tab:nth-child(1):hover{ background:#1a315f !important; }
#__hardMainNav .__tab:nth-child(2):hover{ background:#984800 !important; }
#__hardMainNav .__tab:nth-child(3):hover{ background:#125f3a !important; }

#__hardMainNav .__tab.__active{ filter:brightness(.92) !important; }
</style>
<style>
/* === Completed topics: hide possible 'Add Row' controls === */
/* Try common generator patterns; safe fallbacks */
[id^="topic"].completed .add-row,
[id^="topic"].completed .btn-add-row,
[id^="topic"].completed .addRow,
[id^="topic"].completed [data-action="add-row"],
[id^="topic"].completed [data-add-row],
[id^="topic"].completed .controls .add-row {
  display: none !important;
}

/* === Completed topics: center the RESET button === */
[id^="topic"].completed .reset{
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  margin: 16px auto 8px !important; /* center horizontally */
  float: none !important;
}
/* if reset is the only control, make sure its container doesn't force left alignment */
[id^="topic"].completed .controls,
[id^="topic"].completed footer,
[id^="topic"].completed .topic-footer {
  text-align: center !important;
}
</style>
<style>
/* === Dual Edit Modal (two-input) === */
#dualEditOverlay{
  position: fixed; inset: 0; background: rgba(0,0,0,.45);
  display: none; align-items: center; justify-content: center; z-index: 10000;
}
#dualEditModal{
  background: #2b2f36; color: #fff; border-radius: 10px; padding: 16px 18px; min-width: 360px;
  box-shadow: 0 10px 30px rgba(0,0,0,.6);
}
#dualEditModal h4{ margin: 0 0 12px; font-weight: 700; font-size: 16px; text-align:center; }
#dualEditModal .row{ display:flex; gap: 10px; margin-bottom: 12px; }
#dualEditModal label{ font-size: 12px; opacity:.9; display:block; margin-bottom: 4px; }
#dualEditModal input{
  width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,.15);
  background:#1f2227; color:#fff;
}
#dualEditModal .actions{ display:flex; gap:10px; justify-content:center; margin-top: 6px; }
#dualEditModal button{
  padding: 8px 12px; border-radius: 8px; border: 0; cursor: pointer; font-weight: 700;
}
#dualEditOK{ background:#0d6efd; color:#fff; }
#dualEditCancel{ background:#6c757d; color:#fff; }
</style>
<style>
    .title-edit-wrap{ display:inline-flex; align-items:center; gap:8px; }
    .title-edit-btn{ 
/* Başlık ortalama */
.topic-box h2 {
  text-align: center;
  width: 100%;
}

/* Düzenleme butonu stil: kare çerçeve içinde ortalanmış dolma kalem */
.title-edit-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px !important;
  width: 32px !important;
  height: 32px !important;
  border: 2px solid currentColor !important;
  border-radius: 6px !important;
  background: transparent !important;
}

      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);
      color:inherit; cursor:pointer;
      width:28px; height:28px; border-radius:8px;
      font-size:14px; line-height:1;
    }
    .title-edit-btn:hover{ background:rgba(255,255,255,.18); }
    body.light .title-edit-btn{ 
/* Başlık ortalama */
.topic-box h2 {
  text-align: center;
  width: 100%;
}

/* Düzenleme butonu stil: kare çerçeve içinde ortalanmış dolma kalem */
.title-edit-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px !important;
  width: 32px !important;
  height: 32px !important;
  border: 2px solid currentColor !important;
  border-radius: 6px !important;
  background: transparent !important;
}

      border-color: rgba(0,0,0,.2);
      background: rgba(0,0,0,.06);
    }
    body.light .title-edit-btn:hover{ background: rgba(0,0,0,.14); }
  </style></head>
<body>
<div id="topTitleBar"><span class="title-edit-wrap" id="globalResetWrap"><h3 id="globalReset">FENIX A320 SMART CHECKLIST</h3><button type="button" class="title-edit-btn" aria-label="Başlığı düzenle" title="Başlığı düzenle">🖊️</button></span></div><nav id="__hardMainNav"><a class="__tab __active" href="Son.html">VATSIM CHKL</a><a class="__tab" href="prelim.html">PRELIM CHKL</a><a class="__tab" href="normal.html">NORMAL CHKL</a></nav>
<div id="topControls"><button id="infoToggle">ℹ️</button><button id="themeToggle">☀️</button><button id="exportToggle">💾</button><button id="restoreToggle">⟲</button></div>
<section aria-label="AIRCRAFT POWER" class="topic-box completed" id="topic1">
<div class="title-edit-wrap"><h2>AIRCRAFT POWER</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item done hidden" data-note-id="n1" id="item-n1" data-key="EXTERNAL POWER ON"><p data-raw="EXTERNAL POWER ON"><span class="l">EXTERNAL POWER</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n2" id="item-n2" data-key="BAT 1 &amp; 2 ON"><p data-raw="BAT 1 &amp; 2 ON"><span class="l">BAT 1 &amp; 2</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="EFB INITIALIZATION" class="topic-box completed" id="topic2">
<div class="title-edit-wrap"><h2>EFB INITIALIZATION</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item simbrief done hidden" data-note-id="n3" id="item-n3" data-key="SIMBRIEF DATA IMPORT"><p data-raw="SIMBRIEF DATA IMPORT"><span class="l">SIMBRIEF DATA</span><span class="dotfill" aria-hidden="true"></span><span class="r">IMPORT</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n4" id="item-n4" data-key="GROUND SERVICES SET"><p data-raw="GROUND SERVICES SET"><span class="l">GROUND SERVICES</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n5" id="item-n5" data-key="MASS AND BALANCE LOAD"><p data-raw="MASS AND BALANCE LOAD"><span class="l">MASS AND BALANCE</span><span class="dotfill" aria-hidden="true"></span><span class="r">LOAD</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="OVERHEAD PREPARATION" class="topic-box completed" id="topic3">
<div class="title-edit-wrap"><h2>OVERHEAD PREPARATION</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<div class="item done hidden" data-note-id="n6" id="item-n6" role="button" tabindex="0" data-key="CREW SUPPLY ON">
<!-- Alt maddeler -->
<ul class="sub-list">
<li> CREW SUPPLY  ON</li>
<li> GND CTL ON</li>
<li> CVR TEST PERFORM</li>
<li> EVAC SWITCH  CAPT</li>
<li> ADIRS  NAV</li>
<li> EMER EXIT LT ARM</li>
<li> NO SMOKING AUTO</li>
<li> SEAT BELTS ON</li>
<li> NAV &amp; LOGO LT POSITION 1</li>
<li> FUEL PUMPS ON </li>
</ul>
<span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></div>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="MCDU DIFSRIPP SETUP" class="topic-box completed" id="topic4">
<div class="title-edit-wrap"><h2>MCDU DIFSRIPP SETUP</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item done hidden" data-note-id="n7" id="item-n7" data-key="DATA CHECK DATABASE"><p data-raw="DATA CHECK DATABASE"><span class="l">DATA CHECK</span><span class="dotfill" aria-hidden="true"></span><span class="r">DATABASE</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n8" id="item-n8" data-key="INIT (A Page) INIT REQUEST"><p data-raw="INIT (A Page) INIT REQUEST"><span class="l">INIT (A Page) INIT</span><span class="dotfill" aria-hidden="true"></span><span class="r">REQUEST</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n9" id="item-n9" data-key="F-PLN SET DEP / ARR"><p data-raw="F-PLN SET DEP / ARR"><span class="l">F-PLN SET DEP /</span><span class="dotfill" aria-hidden="true"></span><span class="r">ARR</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n10" id="item-n10" data-key="SEC F-PLN COPY ACTIVE"><p data-raw="SEC F-PLN COPY ACTIVE"><span class="l">SEC F-PLN COPY</span><span class="dotfill" aria-hidden="true"></span><span class="r">ACTIVE</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n11" id="item-n11" data-key="RAD NAV FORCE NEARBY"><p data-raw="RAD NAV FORCE NEARBY"><span class="l">RAD NAV FORCE</span><span class="dotfill" aria-hidden="true"></span><span class="r">NEARBY</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n12" id="item-n12" data-key="INIT (B Page) SET"><p data-raw="INIT (B Page) SET"><span class="l">INIT (B Page)</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n13" id="item-n13" data-key="PERF SET"><p data-raw="PERF SET"><span class="l">PERF</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n14" id="item-n14" data-key="PROG SET"><p data-raw="PROG SET"><span class="l">PROG</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="CENTER PEDESTAL SETUP" class="topic-box" id="topic5">
<div class="title-edit-wrap"><h2>CENTER PEDESTAL SETUP</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<div class="item" data-note-id="n15" id="item-n15" role="button" tabindex="0" data-key="RADIO MANAGEMENT AND AUDIO CONTROL PANEL (RMP &amp; ACP)">
<!-- Üst satır -->
<div class="header-line">
<span class="l">RADIO MANAGEMENT AND AUDIO CONTROL PANEL (RMP &amp; ACP)</span>
<span aria-hidden="true" class="dotfill"></span>
</div>
<!-- Alt maddeler -->
<ul class="sub-list">
<li> VATSIM Frequency SET</li>
<li> VHF1 &amp; VHF2 KNOB ON</li>
<li> INT &amp; CAB KNOB ON</li>
<li> PA KNOB ON</li>
<li> VHF1 SELECTED ON RIGHT SIDE (If you are flying as a co-pilot) </li>
<li> TCAS ON</li>
</ul>
<span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></div>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="Pre-Departure Clearance (CPDLC)" class="topic-box" id="topic6">
<div class="title-edit-wrap"><h2>Pre-Departure Clearance (CPDLC)</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<div class="item" data-note-id="n16" id="item-n16" role="button" tabindex="0" data-key="CHECK ATIS &amp; METAR">
<!-- Alt maddeler -->
<ul class="sub-list">
<li> CHECK ATIS &amp; METAR</li>
<li> STAND NUMBER | DESTINATION | INFORMATION (for voice clearance)</li>
<li> MCDU MENU &gt; ATSU &gt; AOC MENU &gt; FLT INIT &gt; INIT DATA REQ</li>
<li> MCDU MENU &gt; ATSU &gt; AOC MENU &gt; ATC REQ &gt; PRE DEP CLRNCE &gt; FILL &gt; SEND </li>
<li> DEPARTURE SID  CHECK &amp; SET</li>
<li> SQUAWK SET</li>
<li> BARO REF  SET BOTH</li>
<li> INITIAL CLIMB  SET</li>
</ul><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></div><button class="item" data-note-id="n17" id="item-n17" data-key="APU START"><p data-raw="APU START"><span class="l">APU</span><span class="dotfill" aria-hidden="true"></span><span class="r">START</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n18" id="item-n18" data-key="APU BLEED ON"><p data-raw="APU BLEED ON"><span class="l">APU BLEED</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n19" id="item-n19" data-key="EXTERNAL POWER OFF"><p data-raw="EXTERNAL POWER OFF"><span class="l">EXTERNAL POWER</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="PUSHBACK AND STARTUP" class="topic-box" id="topic7">
<div class="title-edit-wrap"><h2>PUSHBACK AND STARTUP</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n20" id="item-n20" data-key="GROUND CONNECTIONS REMOVE"><p data-raw="GROUND CONNECTIONS REMOVE"><span class="l">GROUND CONNECTIONS</span><span class="dotfill" aria-hidden="true"></span><span class="r">REMOVE</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n21" id="item-n21" data-key="WINDOWS/DOORS CLOSED (BOTH)"><p data-raw="WINDOWS/DOORS CLOSED (BOTH)"><span class="l">WINDOWS/DOORS CLOSED</span><span class="dotfill" aria-hidden="true"></span><span class="r">(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n22" id="item-n22" data-key="PUSHBACK TUG CONNECT"><p data-raw="PUSHBACK TUG CONNECT"><span class="l">PUSHBACK TUG</span><span class="dotfill" aria-hidden="true"></span><span class="r">CONNECT</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n23" id="item-n23" data-key="PARKING BRAKE OFF"><p data-raw="PARKING BRAKE OFF"><span class="l">PARKING BRAKE</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n24" id="item-n24" data-key="TCAS TA/RA"><p data-raw="TCAS TA/RA"><span class="l">TCAS</span><span class="dotfill" aria-hidden="true"></span><span class="r">TA/RA</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n25" id="item-n25" data-key="BEACON ON"><p data-raw="BEACON ON"><span class="l">BEACON</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="AFTER START" class="topic-box completed" id="topic8">
<div class="title-edit-wrap"><h2>AFTER START </h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item done hidden" data-note-id="n26" id="item-n26" data-key="ANTI ICE ____"><p data-raw="ANTI ICE ____"><span class="l">ANTI ICE</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n27" id="item-n27" data-key="ECAM STATUS CHECKED"><p data-raw="ECAM STATUS CHECKED"><span class="l">ECAM STATUS</span><span class="dotfill" aria-hidden="true"></span><span class="r">CHECKED</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n28" id="item-n28" data-key="PITCH TRIM ____%"><p data-raw="PITCH TRIM ____%"><span class="l">PITCH TRIM</span><span class="dotfill" aria-hidden="true"></span><span class="r">____%</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n29" id="item-n29" data-key="RUDDER TRIM NEUTRAL"><p data-raw="RUDDER TRIM NEUTRAL"><span class="l">RUDDER TRIM</span><span class="dotfill" aria-hidden="true"></span><span class="r">NEUTRAL</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n30" id="item-n30" data-key="FLIGHT CONTROLS CHECKED(BOTH)"><p data-raw="FLIGHT CONTROLS CHECKED(BOTH)"><span class="l">FLIGHT CONTROLS</span><span class="dotfill" aria-hidden="true"></span><span class="r">CHECKED(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n31" id="item-n31" data-key="FLIGHT INST CHECKED(BOTH)"><p data-raw="FLIGHT INST CHECKED(BOTH)"><span class="l">FLIGHT INST</span><span class="dotfill" aria-hidden="true"></span><span class="r">CHECKED(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n32" id="item-n32" data-key="FLAPS SETTING CONF ____(BOTH)"><p data-raw="FLAPS SETTING CONF ____(BOTH)"><span class="l">FLAPS SETTING CONF</span><span class="dotfill" aria-hidden="true"></span><span class="r">____(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n33" id="item-n33" data-key="RADAR &amp; PRED W/S ON &amp; ON"><p data-raw="RADAR &amp; PRED W/S ON &amp; ON"><span class="l">RADAR &amp; PRED W/S ON &amp;</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n34" id="item-n34" data-key="ENG MODE SEL ____"><p data-raw="ENG MODE SEL ____"><span class="l">ENG MODE SEL</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n35" id="item-n35" data-key="APU OFF"><p data-raw="APU OFF"><span class="l">APU</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item done hidden" data-note-id="n36" id="item-n36" data-key="APU BLEED OFF"><p data-raw="APU BLEED OFF"><span class="l">APU BLEED</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="TAXI" class="topic-box completed" id="topic9">
<div class="title-edit-wrap"><h2>TAXI</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<div class="item done hidden" data-note-id="n37" id="item-n37" role="button" tabindex="0" data-key="ECAM MEMO">
<!-- Üst satır -->
<div class="header-line">
<span class="l">ECAM MEMO</span>
<span aria-hidden="true" class="dotfill"></span>
<span class="r">TO NO BLUE</span>
</div>
<!-- Alt maddeler -->
<ul class="sub-list">
<li> AUTO BRK MAX</li>
<li> SEAT BELTS ON</li>
<li> CABIN READY</li>
<li> SPLRS ARM</li>
<li> FLAPS T.O</li>
<li> T.O CONFIG NORMAL</li>
</ul>
<span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></div>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="LINE-UP" class="topic-box" id="topic10">
<div class="title-edit-wrap"><h2>LINE-UP </h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n38" id="item-n38" data-key="T.O RWY ____(BOTH)" data-last-focus="1"><p data-raw="T.O RWY ____(BOTH)"><span class="l">T.O RWY</span><span class="dotfill" aria-hidden="true"></span><span class="r">____(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n39" id="item-n39" data-key="CABIN CREW ADVISED"><p data-raw="CABIN CREW ADVISED"><span class="l">CABIN CREW</span><span class="dotfill" aria-hidden="true"></span><span class="r">ADVISED</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n40" id="item-n40" data-key="PACKS 1 &amp; 2 ____"><p data-raw="PACKS 1 &amp; 2 ____"><span class="l">PACKS 1 &amp; 2</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n41" id="item-n41" data-key="ALL LIGHTS ON"><p data-raw="ALL LIGHTS ON"><span class="l">ALL LIGHTS</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="DEPARTURE CHANGE" class="topic-box" id="topic11">
<div class="title-edit-wrap"><h2>DEPARTURE CHANGE</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n42" id="item-n42" data-key="RWY &amp; SID &amp; NADP ____"><p data-raw="RWY &amp; SID &amp; NADP ____"><span class="l">RWY &amp; SID &amp; NADP</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n43" id="item-n43" data-key="FLAPS SETTING CONF ____ (BOTH)"><p data-raw="FLAPS SETTING CONF ____ (BOTH)"><span class="l">FLAPS SETTING CONF ____</span><span class="dotfill" aria-hidden="true"></span><span class="r">(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n44" id="item-n44" data-key="T.O SPEEDS &amp; THRUST ____(BOTH)"><p data-raw="T.O SPEEDS &amp; THRUST ____(BOTH)"><span class="l">T.O SPEEDS &amp; THRUST</span><span class="dotfill" aria-hidden="true"></span><span class="r">____(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n45" id="item-n45" data-key="FCU ALT ____"><p data-raw="FCU ALT ____"><span class="l">FCU ALT</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="APPROACH" class="topic-box" id="topic12">
<div class="title-edit-wrap"><h2>APPROACH</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n46" id="item-n46" data-key="BARO REF ____(BOTH)"><p data-raw="BARO REF ____(BOTH)"><span class="l">BARO REF</span><span class="dotfill" aria-hidden="true"></span><span class="r">____(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n47" id="item-n47" data-key="SEAT BELTS ON"><p data-raw="SEAT BELTS ON"><span class="l">SEAT BELTS</span><span class="dotfill" aria-hidden="true"></span><span class="r">ON</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n48" id="item-n48" data-key="MINIMUM ____"><p data-raw="MINIMUM ____"><span class="l">MINIMUM</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n49" id="item-n49" data-key="AUTO BRAKE ____"><p data-raw="AUTO BRAKE ____"><span class="l">AUTO BRAKE</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n50" id="item-n50" data-key="ENG MODE SEL ____"><p data-raw="ENG MODE SEL ____"><span class="l">ENG MODE SEL</span><span class="dotfill" aria-hidden="true"></span><span class="r">____</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="LANDING" class="topic-box" id="topic13">
<div class="title-edit-wrap"><h2>LANDING</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<div class="item" data-note-id="n51" id="item-n51" role="button" tabindex="0" data-key="ECAM MEMO">
<!-- Üst satır -->
<div class="header-line">
<span class="l">ECAM MEMO</span>
<span aria-hidden="true" class="dotfill"></span>
<span class="r">LDG NO BLUE</span>
</div>
<!-- Alt maddeler -->
<ul class="sub-list">
<li>LDG GEAR DN</li>
<li>SEAT BELTS  ON</li>
<li>CABIN READY</li>
<li>SPLRS ARM</li>
<li> FLAPS FULL or CONF 3</li>
</ul>
<span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></div>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="AFTER LANDING" class="topic-box" id="topic14">
<div class="title-edit-wrap"><h2>AFTER LANDING</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n52" id="item-n52" data-key="RADAR &amp; PRED W/S OFF"><p data-raw="RADAR &amp; PRED W/S OFF"><span class="l">RADAR &amp; PRED W/S</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="PARKING" class="topic-box" id="topic15">
<div class="title-edit-wrap"><h2>PARKING</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n53" id="item-n53" data-key="PARK BRK OR CHOCKS SET"><p data-raw="PARK BRK OR CHOCKS SET"><span class="l">PARK BRK OR CHOCKS</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n54" id="item-n54" data-key="ENGINES OFF"><p data-raw="ENGINES OFF"><span class="l">ENGINES</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n55" id="item-n55" data-key="WING LIGHTS OFF"><p data-raw="WING LIGHTS OFF"><span class="l">WING LIGHTS</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n56" id="item-n56" data-key="FUEL PUMPS OFF"><p data-raw="FUEL PUMPS OFF"><span class="l">FUEL PUMPS</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<section aria-label="SECURING THE AIRCRAFT" class="topic-box" id="topic16">
<div class="title-edit-wrap"><h2>SECURING THE AIRCRAFT</h2><button type="button" class="title-edit-btn" aria-label="Bölüm başlığını düzenle" title="Bölüm başlığını düzenle">🖊️</button></div>
<button class="item" data-note-id="n57" id="item-n57" data-key="PARKING BRAKE SET"><p data-raw="PARKING BRAKE SET"><span class="l">PARKING BRAKE</span><span class="dotfill" aria-hidden="true"></span><span class="r">SET</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n58" id="item-n58" data-key="ADIRS OFF"><p data-raw="ADIRS OFF"><span class="l">ADIRS</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n59" id="item-n59" data-key="OXYGEN OFF"><p data-raw="OXYGEN OFF"><span class="l">OXYGEN</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n60" id="item-n60" data-key="EMER EXIT LT OFF"><p data-raw="EMER EXIT LT OFF"><span class="l">EMER EXIT LT</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n61" id="item-n61" data-key="EFBs OFF (BOTH)"><p data-raw="EFBs OFF (BOTH)"><span class="l">EFBs OFF</span><span class="dotfill" aria-hidden="true"></span><span class="r">(BOTH)</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<button class="item" data-note-id="n62" id="item-n62" data-key="APU AND BATTERIES OFF"><p data-raw="APU AND BATTERIES OFF"><span class="l">APU AND BATTERIES</span><span class="dotfill" aria-hidden="true"></span><span class="r">OFF</span></p><span class="info-btn" role="button" tabindex="0" aria-label="Açıklamayı göster">?</span></button>
<div class="actions"><button class="reset" data-reset="">Reset</button><button class="add-row">Add Row</button></div></section>
<!-- Madde açıklama Modal (QUESTION/?) -->
<div aria-labelledby="descTitle" aria-modal="true" class="modal" id="descModal" role="dialog">
<div class="modal-card">
<div class="modal-header"><div class="modal-left"><div class="modal-title" id="descTitle">T.O RWY____(BOTH)</div><button class="copy-btn" id="editItemBtn" style="background:#1f2937;border:1px solid #555;font-size:14px;padding:6px 12px;line-height:1;min-width:100px;text-align:center;margin-left:6px;">Edit Item</button> <button class="copy-btn" id="deleteItemBtn" style="background:#7f1d1d;border:1px solid #dc2626;font-size:14px;padding:6px 12px;line-height:1;min-width:100px;text-align:center;">Delete Item</button></div><button aria-label="Kapat" class="close-btn">×</button></div>
<div class="modal-body" id="descBody" contenteditable="false">Apply ENG/WING anti-ice per OAT/visible moisture/icing conditions. Monitor ICE DET and engine parameters.</div>
<div class="modal-footer">
<button class="copy-btn" id="editBtn" style="margin-right: auto; display: inline-block;">Update Note</button>
<button class="copy-btn" id="saveEditBtn" style="display: none;">Save</button>
<button class="copy-btn" id="copyBtn">Complete</button>
</div>
</div>
</div>
<!-- Doküman Özellikleri Popup (sade, içerik senin) -->
<!--
📚 Amaç: Checklist uygulamasının JS mantığını düzenli, net ve erişilebilir bir yapıda sunmak.
Sıra: Yardımcılar → Veri → DOM Referansları → Modal Yardımcıları → Builder/Logic → Event Wiring → Init → Ek Özellikler
-->
<script>
/* =========================================================
   🔧 YARDIMCI FONKSİYONLAR
   - normalizeKey: Anahtarları tekilleştirir (boşlukları normalize eder)
   ========================================================= */
const normalizeKey = (s) => (s || "").replace(/\s+/g, " ").trim();

/* =========================================================
   📒 FCOM / AÇIKLAMA VERİLERİ
   - FCOM_NOTES_RAW: Başlık → HTML açıklama metni
   - FCOM_NOTES: normalize edilmiş sözlük (erişim kolaylığı)
   ========================================================= */
const FCOM_NOTES_RAW = {
  "n1":"Connect EXT PWR when available and within limits. When ON, AC buses are powered by GPU unless engine generators are online. Verify on ELEC page that EXT PWR is supplying and parameters are within range.",
  "n2":"Before long downtime starts, check battery voltage (>25.5 V) then set to AUTO. With AUTO selected, contactors close for charge. Limit time on batteries alone; start APU promptly if needed.",
  "n3":"Import Simbrief Data from My Flights page.<br><a href=\\"https://dispatch.simbrief.com/home\\" target=\\"_blank\\">Open Simbrief Dispatch</a> ",
  "n4":"Configure chocks, GPU, air/conditioning and doors according to turn-around phase. Remove equipment prior pushback per SOP. ",
  "n5":"Load payload and fuel (instant/fast/real-time). Confirm loadsheet values and ensure MCDU GW/CG match within tolerance. ",
  "n6":"Use secondary for contingency (e.g., return or diversion). Copy active plan or build alternate; arm for quick activation during abnormal situations.",
  "n7":"On MCDU DATA/STATUS verify airframe/engine variant and NAV database validity (cycle/date). Discrepancy requires maintenance or data reload before dispatch. ",
  "n8":"Fill or request basic flight data: dep/arr aerodromes, alternate, flight number, CI, cruise level/temperature. Cross-check with operational flight plan. ",
  "n9":"Insert SID, enroute segments and expected STAR/runway. Ensure discontinuities resolved as needed and any ATC constraints are reflected. ",
  "n10":"Use secondary for contingency (e.g., return or diversion). Copy active plan or build alternate; arm for quick activation during abnormal situations. ",
  "n11":"Manual tune VOR/ILS as required (e.g., departure aid or nav signal protection). Clear manual tuning when no longer needed to restore autotune. "https://dispatch.simbrief.com/home\" target=\"_blank\">Open Simbrief Dispatch</a>",
  "n12":"Enter ZFW/ZFWCG, block fuel or FOB as applicable. Check GW and CG computed by FMGC against loadsheet. Ensure prediction values update. ",
  "n13":"Enter TO/CLB/CRZ/LAND parameters: flap/THR RED/ACC altitudes, flex or TOGA strategy, V1/Vr/V2, approach profile and autobrake as planned. ",
  "n14":"Monitor BRG/DIST references, step climbs, predicted fuel/time. Insert expected cruise wind/temp if required by SOPs to refine predictions. ",
  "n15":"- Set active VHF according to crew role; adjust ACP volumes/sources. Confirm intercom/PA as needed. For online networks, verify COM1/COM2 mapping.  - Tune clearance/ground/tower per airport charts or network info. Maintain correct mic select and monitor guard if company procedures require.  - Transceivers; select primary TX on the intended radio. Check sidetone and volume.  - interphone/cabin channels as required for crew coordination; set volumes to avoid masking alerts.  - Arm/adjust PA for announcements; ensure it does not inhibit critical aural alerts during takeoff/landing.  - Right seat selects the appropriate TX source to avoid dual-keying; confirm cross-cockpit communication.  - Set TCAS to STBY before push; TA/RA for takeoff. Verify transponder code and mode; ensure correct altitude ",
  "n16":"Enable transceivers; select primary TX on the intended radio. Check sidetone and volume.",
  "n17":"Start when needed for electrics/air. Monitor EGT and AVAIL; ensure APU BLEED configuration before engine start. ",
  "n18":"Select BLEED ON to supply packs or engine start air. Verify pack/bleed configuration to avoid pressure/temperature excursions. ",
  "n19":"Right seat selects the appropriate TX source to avoid dual-keying; confirm cross-cockpit communication.",
  "n20":"Remove chocks/GPU/air and close doors before pushback; confirm on ECAM WHEEL/DOOR pages. ",
  "n21":"Cabin/flight deck doors and windows closed and locked; check ECAM MEMO status shows no door/slide warnings. ",
  "n22":"Request and confirm tug status/route. Ensure parking brake set before pushback commences. ",
  "n23":"Release on tug instruction; monitor brake pressure and confirm movement ",
  "n24":"Set TA/RA; verify transponder to AUTO/TA/RA. ",
  "n25":"Select BEACON ON prior push/start to signal ground personnel. ",
  "n26":"Apply ENG/WING anti-ice per OAT/visible moisture/icing conditions. Monitor ICE DET and engine parameters. ",
  "n27":"After start, review STATUS for inoperative systems or deferred items; action required procedures. ",
  "n28":"Set stabilizer per PERF/TO data; cross-check both sides. ",
  "n29":"Verify centered prior to taxi; avoids takeoff roll asymmetry. ",
  "n30":"Full and free movement; check F/CTL page for correct deflections and spoilers. ",
  "n31":"PFD/ND alignment, FMA/FD modes, QNH, heading, IRS alignment verified. ",
  "n32":"Set planned flap conf; check ECAM/Flap scale indications and takeoff speeds. ",
  "n33":"Arming weather radar and predictive windshear per SOP; avoid sweeping on stand facing terminals. ",
  "n34":"Set IGN/START for engine start or NORM otherwise per phase. ",
  "n35":"After engine start and electrical/bleed transfer, stop APU unless needed. ",
  "n36":"Select OFF when engine bleeds/packs configured for taxi/takeoff. ",
  "n37":"Select BEACON ON prior push/start to signal ground personnel.",
  "n38":"Apply ENG/WING anti-ice per OAT/visible moisture/icing conditions. Monitor ICE DET and engine parameters.",
  "n39":"After start, review STATUS for inoperative systems or deferred items; action required procedures.",
  "n40":"Set stabilizer per PERF/TO data; cross-check both sides.",
  "n41":"Verify centered prior to taxi; avoids takeoff roll asymmetry.",
  "n42":"Full and free movement; check F/CTL page for correct deflections and spoilers.",
  "n43":"PFD/ND alignment, FMA/FD modes, QNH, heading, IRS alignment verified.",
  "n44":"Set planned flap conf; check ECAM/Flap scale indications and takeoff speeds.",
  "n45":"Arming weather radar and predictive windshear per SOP; avoid sweeping on stand facing terminals.",
  "n46":"Set IGN/START for engine start or NORM otherwise per phase.",
  "n47":"After engine start and electrical/bleed transfer, stop APU unless needed.",
  "n48":"Select OFF when engine bleeds/packs configured for taxi/takeoff.",
  "n49":"Taxi/TO MEMO should display 'TO NO BLUE' before line-up; resolve any blue items prior to takeoff.",
  "n50":"Set per takeoff performance/contaminated runway policy or RTO strategy.",
  "n51":"Cabin signs ON before taxi/takeoff; advise cabin crew.",
  "n52":"Obtain cabin ready from purser before line-up.",
  "n53":"Arm spoilers for automatic deployment on reject/landing as applicable.",
  "n54":"Configure landing flaps per performance/NOTAM; verify speed constraints.",
  "n55":"After landing clear of runway, select off as per SOP to avoid ramp irradiation.",
  "n56":"At stand, set PBK or install chocks; confirm ECAM memo.",
  "n57":"Fuel levers OFF; monitor spool-down and status.",
  "n58":"Set exterior lights per ramp safety; strobe off after vacating runway.",
  "n59":"Switch off as required after shutdown unless fuel transfer needed.",
  "n60":"Before securing, set brake if chocks not in place.",
  "n61":"If aircraft fully secured, switch IRS OFF; observe alignment status before power down.",
  "n62":"Shut off crew oxygen if required by securing procedure.",
  "n63":"Select OFF when aircraft is fully powered down and at gate as per SOP.",
  "n64":"Shut down portable devices or stow; avoid battery drain.",
  "n65":"When ground power available and checks complete, stop APU and set BAT to OFF."
};

const FCOM_NOTES_BY_ID = FCOM_NOTES_RAW;

/* =========================================================
   📦 GRUP NOTLARI (Alt listeler için toplu açıklamalar)
   - topic başlığına göre modalda madde+not listesi üretir
   ========================================================= */
const GROUP_NOTES = {
  "OVERHEAD PREPARATION": [
    { title: "CREW SUPPLY ON", notes: [
      "CREW OXY pb ON: supply pressurized oxygen to masks.",
      "Check OXY pressure on DOOR/OXY page (value depends on temperature).",
    ]},
    { title: "GND CTL ON", notes: [
      "On ground, when GND CTL pb-sw is pressed, the CVR is recording.",
    ]},
    { title: "CVR TEST PERFORM", notes: [
      "When pressed and held:This activates the test, if the CVR is on (the GND CTL pb-sw pressed, or during the first 5 min after energization of the aircraft electrical network), and the parking brake is on.",
    ]},
    { title: "EVAC SWITCH CAPT", notes: [
      "EVAC CMD switch guarded and in CAPT position.",
      "Prevents inadvertent cabin-initiation when not intended."
    ]},
    { title: "ADIRS NAV", notes: [
      "Select all three IR mode selectors to NAV.",
      "Alignment ~10 min (fast align if needed); monitor IRS status on MCDU/ND."
    ]},
    { title: "EMER EXIT LT ARM", notes: [
      "ARM so emergency lights illuminate automatically if DC power lost.",
      "Verify EMER LT pb is guarded."
    ]},
    { title: "NO SMOKING AUTO", notes: [
      "AUTO enables automatic sign logic linked to gear/flaps.",
      "Use ON when required (turbulence/smoke)."
    ]},
    { title: "SEAT BELTS ON", notes: [
      "Set ON before push/taxi; coordinate with cabin crew.",
      "Expect 'Cabin Ready' before line-up."
    ]},
    { title: "NAV & LOGO LT POSITION 1", notes: [
      "Select position 1 (or 2 as alternate).",
      "Provides steady NAV lights; check exterior light config per SOP."
    ]},
    { title: "FUEL PUMPS ON", notes: [
      "All tank pumps ON to ensure feed pressure before start.",
      "Verify ECAM FUEL page shows pressure available."
    ]}
  ],
  "Pre-Departure Clearance (CPDLC)": [
    { title: "CHECK ATIS & METAR", notes: [
      "Obtain current ATIS/METAR before clearance.",
    ]},
    { title: "STAND NUMBER | DESTINATION | INFORMATION (for voice clearance)", notes: [
      "Prepare info for ATC readout: stand position, departure/destination aerodromes, flight number.",
      "Facilitates correct and efficient clearance delivery."
    ]},
    { title: "MCDU MENU > ATSU > AOC MENU > FLT INIT > INIT DATA REQ", notes: [
      "Request flight data uplink via ACARS/AOC.",
    ]},
    { title: "MCDU MENU > ATSU > AOC MENU > ATC REQ > PRE DEP CLRNCE > FILL > SEND", notes: [
      "Send Pre-Departure Clearance request via CPDLC.",
      "Verify uplinked clearance (SID, squawk, level) before acceptance."
    ]},
    { title: "DEPARTURE SID CHECK & SET", notes: [
      "Confirm assigned SID loaded in MCDU F-PLN.",
    ]},
    { title: "SQUAWK SET", notes: [
      "Insert assigned squawk code in transponder.",
    ]},
    { title: "BARO REF SET BOTH", notes: [
      "Set QNH on both PFDs.",
      "Perform cross-check: max 100 ft difference between instruments."
    ]},
    { title: "INITIAL CLIMB SET", notes: [
      "Insert cleared initial climb altitude/heading in FCU.",
      "Brief any noise abatement or SID-related constraints."
    ]}
  ]
};

/* =========================================================
   🔗 GLOBAL DURUM
   - currentItemEl: modal ile ilgili o anki madde referansı
   ========================================================= */
let currentItemEl = null;

/* =========================================================
   🔎 DOM REFERANSLARI (Modal ve Kontroller)
   - Modal elemanları ve butonlar
   ========================================================= */
const modal      = document.getElementById('descModal');
const modalTitle = document.getElementById('descTitle');
const modalBody  = document.getElementById('descBody');
const copyBtn    = document.getElementById('copyBtn');
const closeBtn   = document.querySelector('.close-btn');

/* =========================================================
   🪟 MODAL YARDIMCILARI
   - attachModalClosers: ESC, backdrop, X ile kapatma
   - openDesc / closeDesc: açıklama modalını aç/kapa
   ========================================================= */
function attachModalClosers(){
  // X ile kapat
  if (closeBtn) {
    closeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      closeDesc();
    });
  }
  // Backdrop tıklaması ile kapat
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeDesc();
    });
  }
  // ESC ile kapat
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('show')) {
      closeDesc();
    }
  });
}

function openDesc(id){
    const text = (FCOM_NOTES_BY_ID && FCOM_NOTES_BY_ID[id]) || '';

  // Başlık: ilgili satırın görünen sol kısmı
  let titleText = '';
  try{
    const row = document.querySelector(`.item[data-note-id="${id}"]`);
    const p = row ? row.querySelector('p, .l, .item-text') : null;
    titleText = p ? (p.textContent || '').trim() : id;
  }catch(_){ titleText = id; }
  if (modalTitle) modalTitle.textContent = titleText;
  if (modalBody) {
    modalBody.innerHTML = text
      ? text
      : "No description has been entered for this item yet.";
  }
  modal?.classList.add('show');

  if (!currentItemEl) {
    currentItemEl = document.querySelector(`.item[data-note-id="${id}"]`);
  }
  // Erişilebilirlik: modal açılınca hızlıca X butonuna odaklan
  setTimeout(() => closeBtn?.focus(), 10);
}

function closeDesc(){
  modal?.classList.remove('show');
  currentItemEl = null;
}

/* =========================================================
   ✏️ BUILDER: Madde satırlarını (l ... r) yapısına dönüştürme
   - buildLeaders: "LEFT .... RIGHT" ayrışması ve ? butonu ekleme
   ========================================================= */
function buildLeaders() {
  document.querySelectorAll('.item p').forEach(p => {
    const rawOriginal = p.textContent;
    const raw = rawOriginal.replace(/\s+/g, ' ').trim();
    let left = "", right = "";

    // 1) Kullanıcı iki+ boşlukla manuel ayırmışsa
    const manual = rawOriginal.match(/^(.*?)\s{2,}(.*)$/);
    if (manual) {
      left  = manual[1].trim();
      right = manual[2].trim();
    } else {
      // 2) Nokta/boşluk lideri ile ayır
      const m = raw.match(/^(.*?)[.\s]{4,}(.*)$/);
      if (m) {
        left  = m[1].trim();
        right = m[2].trim();
      } else {
        // 3) Son kelimeyi sağa at (varsayılan)
        const parts = raw.split(' ');
        right = parts.pop();
        left  = parts.join(' ');
      }
    }

    const itemEl = p.closest('.item');
    // İçeriği yapılandır
    p.innerHTML = `
      <span class="l">${left}</span>
      <span class="dotfill" aria-hidden="true"></span>
      <span class="r">${right}</span>
    `;

    // .no-info ise buton ekleme
    if (itemEl.classList.contains('no-info')) return;

    // Info (?) butonu ekle ve olaylarını bağla
    const info = document.createElement('span');
    info.className = 'info-btn';
    info.setAttribute('role', 'button');
    info.setAttribute('tabindex', '0');
    info.setAttribute('aria-label', 'Açıklamayı göster');
    info.textContent = '?';
    info.addEventListener('click', (ev) => {
      ev.stopPropagation();
      currentItemEl = itemEl;
      openDesc(itemEl.dataset.noteId);
    });
    info.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault();
        ev.stopPropagation();
        currentItemEl = itemEl;
        openDesc(itemEl.dataset.noteId);
      }
    });
    itemEl.appendChild(info);
  });
}

/* =========================================================
   ✅ TAMAMLANMA / İLERLEME MANTIĞI
   - checkCompletion: oran hesaplar, başlığı .completed yapar
     % barını günceller, tamamlanınca maddeleri gizler (hidden)
   ========================================================= */
function checkCompletion(topicEl){
  const items = topicEl.querySelectorAll('.item');
  const done  = topicEl.querySelectorAll('.item.done');
  const ratio = items.length ? Math.round((done.length / items.length) * 100) : 0;

  // Tüm maddeler tamamlandı mı?
  topicEl.classList.toggle('completed', items.length === done.length && items.length > 0);

  // Opsiyonel ilerleme barı/metni güncelle
  const bar = topicEl.querySelector('.progress .bar');
  const txt = topicEl.querySelector('.progress-text');
  if (bar) bar.style.width = ratio + '%';
  if (txt) txt.textContent = ratio + '%';

  // Tamamlanınca tüm maddeleri gizle; değilse görünür yap
  if (items.length > 0 && items.length === done.length) {
    items.forEach(b => b.classList.add('hidden'));
  } else {
    items.forEach(b => b.classList.remove('hidden'));
  }
}

/* =========================================================
   📝 MADDE/RESET TIKLAMALARI
   - .item tık: done toggle → checkCompletion (ancak son madde ve geride eksik varsa uyar)
   - [data-reset] tık: o topic içini sıfırla
   ========================================================= */
document.addEventListener('click', (e) => {
  const itemBtn  = e.target.closest('.item');
  const resetBtn = e.target.closest('[data-reset]');

  // Madde tıklaması (info-btn’e değilse)
  if (itemBtn && !e.target.classList.contains('info-btn')) {
    const topic = itemBtn.closest('.topic-box');
    const items = Array.from(topic.querySelectorAll('.item'));
    const idx   = items.indexOf(itemBtn);

    // Bu bölümde, tıklanan maddenin ÜSTÜNDE tamamlanmamış madde var mı?
    const firstUndoneIndex = items.findIndex(el => !el.classList.contains('done') && !el.classList.contains('hidden'));
    const hasEarlierUndone = firstUndoneIndex !== -1 && firstUndoneIndex < idx;

    // Kullanıcı en sondaki maddeye tıklıyorsa ve geride tamamlanmamış varsa uyarı ver
    const isLastItem = idx === items.length - 1;

    if (isLastItem && hasEarlierUndone) {
      // Titreşim
      topic.classList.add('shake');
      setTimeout(()=> topic.classList.remove('shake'), 500);

      // İlk eksik maddeye kaydır ve odakla
      const target = items[firstUndoneIndex];
      target.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>{ try { target.focus({preventScroll:true}); } catch(_){} }, 200);
      return; // bu tıklama ile done olmasın
    }

    // Normal davranış
    itemBtn.classList.toggle('done');
    const becameDone = itemBtn.classList.contains('done');
    checkCompletion(topic);
    if (becameDone) { scrollToNextItem(itemBtn); }
    return;
  }

  // Bölüm reset butonu
  if (resetBtn) {
    const topic = resetBtn.closest('.topic-box');
    topic.querySelectorAll('.item').forEach(b => b.classList.remove('done', 'hidden'));
    topic.classList.remove('completed');
    checkCompletion(topic);
    return;
  }
});
/* =========================================================
   ▶️ OTOMATİK SONRAKİ MADDEYE KAYDIRMA
   - Bir madde DONE olduğunda bir sonraki görünür maddeye yumuşak kaydır
   - Odak ver ve kısa süreli vurgula
   ========================================================= */
function scrollToNextItem(currItem){
  if (!currItem) return;

  // Önce aynı bölümdeki sıradaki görünür/done olmayan madde
  const topic = currItem.closest('.topic-box');
  const all = Array.from(topic.querySelectorAll('.item'));
  const idx = all.indexOf(currItem);

  // Yardımcı: uygun aday mı?
  const isCandidate = (el) => el && !el.classList.contains('done') && !el.classList.contains('hidden');

  let next = null;
  for (let i = idx + 1; i < all.length; i++){
    if (isCandidate(all[i])) { next = all[i]; break; }
  }

  // Eğer mevcut bölümde yoksa, sonraki bölümlerde ara
  if (!next){
    let nextTopic = topic.nextElementSibling;
    while (nextTopic){
      if (nextTopic.classList?.contains('topic-box')){
        const cand = Array.from(nextTopic.querySelectorAll('.item')).find(isCandidate);
        if (cand){ next = cand; break; }
      }
      nextTopic = nextTopic.nextElementSibling;
    }
  }

  if (!next) return; // başka görünür madde yok

  // Kaydır + odak + kısa süreli highlight
  next.scrollIntoView({behavior:'smooth', block:'center', inline:'nearest'});
  // Odak gecikmeli; scroll animasyonu başlasın
  setTimeout(()=>{
    try { next.focus({preventScroll:true}); } catch(e){}
    next.classList.add('autoscroll-highlight');
    setTimeout(()=> next.classList.remove('autoscroll-highlight'), 900);
  }, 160);
}


/* =========================================================
   📋 MODAL KOPYALA → MADDEYİ TAMAMLA
   - copyBtn: tıklanınca ilgili maddeyi .done yapar, modalı kapatır
   ========================================================= */
if (copyBtn) {
  copyBtn.addEventListener('click', () => {
    if (currentItemEl) {
      currentItemEl.classList.add('done');
      checkCompletion(currentItemEl.closest('.topic-box'));
    }
    closeDesc();
  });
}

/* =========================================================
   🧩 .item içinde <p> olmayan durumlar için info butonu ekleme
   - addInfoForNonPItems: dataset.key atar ve tek bir ? butonu ekler
   ========================================================= */
(function addInfoForNonPItems(){
  document.querySelectorAll('.item').forEach(itemEl => {
    if (itemEl.classList.contains('no-info')) return;
    if (itemEl.querySelector('.info-btn')) return; // buildLeaders ile eklenmiş olabilir

    // Anahtar metni türet: header-line > .l > ilk <li> > ilk satır
    let keyText = '';
    const headerL = itemEl.querySelector('.header-line .l');
    if (headerL?.textContent.trim()) {
      keyText = headerL.textContent.trim();
    } else {
      const firstLi = itemEl.querySelector('ul li');
      if (firstLi) keyText = firstLi.textContent.trim();
      else keyText = (itemEl.textContent || '').trim().split('\n')[0];
    }
    itemEl.dataset.key = normalizeKey(keyText);

    // Info butonu ekle
    const info = document.createElement('span');
    info.className = 'info-btn';
    info.setAttribute('role','button');
    info.setAttribute('tabindex','0');
    info.setAttribute('aria-label','Açıklamayı göster');
    info.textContent = '?';
    info.addEventListener('click', (ev) => {
      ev.stopPropagation();
      currentItemEl = itemEl;
      openDesc(itemEl.dataset.noteId);
    });
    info.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault();
        ev.stopPropagation();
        currentItemEl = itemEl;
        openDesc(itemEl.dataset.noteId);
      }
    });
    itemEl.appendChild(info);
  });
})();

/* =========================================================
   🧾 GRUP NOTLARI MODALI (Alt liste barındıran .item için)
   - wireGroupInfo: topic başlığına göre GROUP_NOTES modalı açar
   ========================================================= */
(function wireGroupInfo(){
  document.querySelectorAll('.item').forEach(itemEl => {
    if (itemEl.classList.contains('no-info')) return;

    const hasSubList = !!itemEl.querySelector('.sub-list li');
    if (!hasSubList) return;

    // Tek bir info-btn olsun (per li değil)
    const infoBtn = itemEl.querySelector('.info-btn') || (() => {
      const b = document.createElement('span');
      b.className = 'info-btn';
      b.setAttribute('role','button');
      b.setAttribute('tabindex','0');
      b.setAttribute('aria-label','Açıklamayı göster');
      b.textContent = '?';
      itemEl.appendChild(b);
      return b;
    })();

    const sectionTitle =
      itemEl.closest('.topic-box')?.querySelector('h2')?.textContent?.trim() || "";

    infoBtn.onclick = (e) => {
      e.stopPropagation();
      currentItemEl = itemEl;

      const pack = GROUP_NOTES[sectionTitle];
      if (!pack) { openDesc(sectionTitle || 'Info'); return; }

      // Sıralı liste HTML’ini üret
      let html = '<ol style="padding-left:20px;margin:0;">';
      for (const it of pack) {
        html += '<li><b>' + it.title + '</b><ul style="margin:4px 0 10px 18px;">';
        for (const n of it.notes) html += '<li>' + n + '</li>';
        html += '</ul></li>';
      }
      html += '</ol>';

      // Modalı göster
      if (modalTitle) modalTitle.textContent = sectionTitle;
      if (modalBody)  modalBody.innerHTML  = html;
      modal?.classList.add('show');
    };

    infoBtn.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        infoBtn.click();
      }
    };
  });
})();

/* =========================================================
   🎛️ TEMA / GLOBAL RESET / DOC INFO POPUP
   - Tema geçişi: body.light toggle + ikon değişimi
   - Global reset: tüm maddeleri/başlıkları sıfırlar
   - Doc Info: açık/kapalı toggle
   ========================================================= */
const themeToggle  = document.getElementById('themeToggle');
if (themeToggle) {
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light');
    themeToggle.textContent = document.body.classList.contains('light') ? '🌙' : '☀️';
  });
}

const globalReset = document.getElementById('globalReset');
if (globalReset) {
  globalReset.addEventListener('click', () => {
    document.querySelectorAll('.item').forEach(item => item.classList.remove('done','hidden'));
    document.querySelectorAll('.topic-box').forEach(topic => {
      topic.classList.remove('completed');
      checkCompletion(topic);
    });
  });
}

const openDocInfo  = document.getElementById('openDocInfo');
const docInfoModal = document.getElementById('docInfoModal');
const closeDocInfo = document.getElementById('closeDocInfo');

openDocInfo?.addEventListener('click', () => docInfoModal?.classList.add('show'));
closeDocInfo?.addEventListener('click', () => docInfoModal?.classList.remove('show'));
docInfoModal?.addEventListener('click', e => { if (e.target === docInfoModal) docInfoModal.classList.remove('show'); });


/* =========================================================
   🚀 BAŞLATMA
   - Modal kapatma bağları
   - Lider çizgileri ve info butonları
   - Başlangıç ilerleme hesapları
   ========================================================= */
buildLeaders();
attachModalClosers();
document.querySelectorAll('.topic-box').forEach(checkCompletion);


/* =========================================================
   ✏️ FCOM NOTE DÜZENLEME (KORUNAN YAPI)
   - Sadece açıklama metni düzenlenir, checklist yapısı etkilenmez
   ========================================================= */
const editBtn = document.getElementById('editBtn');
const saveEditBtn = document.getElementById('saveEditBtn');

let fcomEdits = {};
try {
  const data = localStorage.getItem('fcomEdits');
  if (data) fcomEdits = JSON.parse(data);
} catch(e){ fcomEdits = {}; }

function saveFcomEdits(){
  try { localStorage.setItem('fcomEdits', JSON.stringify(fcomEdits)); }
  catch(e){ console.error("Save edits error", e); }
}

const originalOpenDesc3 = openDesc;
openDesc = function(key){
  originalOpenDesc3(key);
  const safeKey = (typeof currentItemEl !== 'undefined' && currentItemEl && currentItemEl.dataset && (currentItemEl.dataset.noteId || currentItemEl.dataset.key))
    ? (currentItemEl.dataset.noteId || currentItemEl.dataset.key)
    : normalizeKey(key);
  if (fcomEdits[safeKey]){
    modalBody.textContent = fcomEdits[safeKey];
  }
  modalBody.setAttribute('contenteditable','false');
  if (editBtn) editBtn.style.display='inline-block';
  if (saveEditBtn) saveEditBtn.style.display='none';
};

if (editBtn){
  editBtn.addEventListener('click', ()=>{
    // Clear placeholder if present
    if (modalBody && modalBody.innerText.includes("No description has been entered for this item yet.")){
      modalBody.innerText = "";
    }
    modalBody.setAttribute('contenteditable','true');
    modalBody.focus();
    editBtn.style.display='none';
    saveEditBtn.style.display='inline-block';
  });
}

if (saveEditBtn){
  saveEditBtn.addEventListener('click', ()=>{
    const key = currentItemEl ? (currentItemEl.dataset.noteId || currentItemEl.dataset.key) : null;
    if (key){
      fcomEdits[key] = modalBody.innerText;
      saveFcomEdits();
      // Removed alert here
    }
    modalBody.setAttribute('contenteditable','false');
    editBtn.style.display='inline-block';
    saveEditBtn.style.display='none';
  });
}

/* =========================================================
   💾 EXPORT TO HTML BUTTON (DISK ICON)
   ========================================================= */
const exportToggle = document.getElementById('exportToggle');
function exportToHtml(){
  let edits = {};
  try {
    const data = localStorage.getItem('fcomEdits');
    if (data) edits = JSON.parse(data);
  } catch(e){ edits = {}; }

  let content = document.documentElement.outerHTML;
  const rawRegex = /const FCOM_NOTES_RAW = {([\s\S]*?)};/;
  const m = content.match(rawRegex);
  if (!m){ alert("FCOM_NOTES_RAW not found!"); return; }

  let rawObjText = m[1];
  for (const [key,val] of Object.entries(edits)){
    const safeVal = val.replace(/"/g,'\\\"').replace(/\n/g,' ');
    const keyRegex = new RegExp('"' + key.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&') + '"\\s*:\\s*"[^"]*"', 'g');
    rawObjText = rawObjText.replace(keyRegex, '"' + key + '":"' + safeVal + '"');
  }
  const newContent = content.replace(rawRegex, 'const FCOM_NOTES_RAW = {' + rawObjText + '};');

  const blob = new Blob([newContent], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'checklist_edited.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
if (exportToggle){
  exportToggle.addEventListener('click', exportToHtml);
}


/* =========================================================
   ➕ Add Row next to Reset, and edit/delete via modal header
   (Preserve dotfill & ? by always using <button class="item"><p>...</p></button> and running buildLeaders())
   ========================================================= */
function ensureActionsRow(){
  document.querySelectorAll('.topic-box').forEach(topicEl=>{
    const reset = topicEl.querySelector('[data-reset]');
    if(!reset) return;
    if(reset.closest('.actions')) return; // already wrapped
    const actions = document.createElement('div');
    actions.className = 'actions';
    reset.parentNode.insertBefore(actions, reset);
    actions.appendChild(reset);
    // Add "Add Row" button to the right of Reset
    const add = document.createElement('button');
    add.className = 'add-row';
    add.type = 'button';
    add.textContent = 'Add Row';
    add.addEventListener('click', ()=>{
      const text = prompt('Enter item text (e.g., LEFT .... RIGHT):');
      if(!text) return;
      const btn = document.createElement('button');
      btn.className = 'item custom';
      const p = document.createElement('p');
      p.textContent = text;
      btn.appendChild(p);
      // insert before actions row
      actions.parentNode.insertBefore(btn, actions);
      // Rebuild leaders to add dotfill and ? button
      buildLeaders();
      checkCompletion(topicEl);
      saveCustomItems();
    });
    actions.appendChild(add);
  });
}
ensureActionsRow();

/* Persist custom items (added rows) */
function loadCustomItems(){
  try{
    const data = localStorage.getItem('customItems');
    if(!data) return;
    const obj = JSON.parse(data);
    for(const [topicId, arr] of Object.entries(obj)){
      const topicEl = document.getElementById(topicId);
      if(!topicEl) continue;
      const actions = topicEl.querySelector('.actions') || topicEl.appendChild(document.createElement('div'));
      if(!actions.classList.contains('actions')){
        actions.className='actions';
        const reset = topicEl.querySelector('[data-reset]');
        if(reset) actions.appendChild(reset);
      }
      arr.forEach(text=>{
        const btn = document.createElement('button');
        btn.className = 'item custom';
        const p = document.createElement('p');
        p.textContent = text;
        btn.appendChild(p);
        topicEl.insertBefore(btn, actions);
      });
    }
    // After injecting, rebuild to attach dotfill and ? buttons
    buildLeaders();
    document.querySelectorAll('.topic-box').forEach(checkCompletion);
  }catch(e){ console.error(e); }
}

function saveCustomItems(){
  const payload = {};
  document.querySelectorAll('.topic-box').forEach(topicEl=>{
    const id = topicEl.id;
    const arr = [];
    topicEl.querySelectorAll('.item.custom').forEach(it=>{
      const t = it.querySelector('p')?.textContent.trim();
      if(t) arr.push(t);
    });
    if(arr.length) payload[id] = arr;
  });
  try{ localStorage.setItem('customItems', JSON.stringify(payload)); }
  catch(e){ console.error(e); }
}
// Load custom items now (after initial buildLeaders)
loadCustomItems();

/* Modal header buttons: Edit Item & Delete Item */
const editItemBtn = document.getElementById('editItemBtn');
const deleteItemBtn = document.getElementById('deleteItemBtn');

if(editItemBtn){
  editItemBtn.addEventListener('click', ()=>{
    if(!currentItemEl) return;
    const oldText = (currentItemEl.querySelector('p')?.textContent || '').trim();
    const text = prompt('Edit item text:', oldText);
    if(!text || text === oldText) return;
    const p = currentItemEl.querySelector('p') || currentItemEl.appendChild(document.createElement('p'));
    p.textContent = text;
    // Rebuild dotfill and ? button for this item only:
    buildLeaders(); // safe global rebuild to reattach ? if needed
    checkCompletion(currentItemEl.closest('.topic-box'));
    // If this was custom, persist updated text
    const topicEl = currentItemEl.closest('.topic-box');
    if(currentItemEl.classList.contains('custom')) saveCustomItems();
    // If not custom, we still want the text change to persist upon Export;
    // For now, text is only in DOM; Export will include DOM outerHTML, so OK.
  });
}

if(deleteItemBtn){
  deleteItemBtn.addEventListener('click', ()=>{
    if(!currentItemEl) return;
    const ok = confirm('Are you sure you want to delete this item?');
    if(!ok) return;
    const topicEl = currentItemEl.closest('.topic-box');
    // Remove from localStorage if custom
    if(currentItemEl.classList.contains('custom')){
      saveCustomItems(); // ensure latest before
      const data = localStorage.getItem('customItems');
      if(data){
        try{
          const obj = JSON.parse(data);
          const id = topicEl?.id;
          const txt = (currentItemEl.querySelector('p')?.textContent || '').trim();
          if(id && obj[id]){
            obj[id] = obj[id].filter(t => t.trim() != txt);
            localStorage.setItem('customItems', JSON.stringify(obj));
          }
        }catch(e){ console.error(e); }
      }
    }
    currentItemEl.remove();
    checkCompletion(topicEl);
    closeDesc();
  });
}

/* Rename modal body edit/save buttons: footer already changed to "Update Note" above */


/* =========================================================
   ♻️ RESTORE ORIGINAL (Safe reload so CSS/JS re-init properly)
   - Clears localStorage keys
   - Forces a hard reload with a cache-busting query string
   ========================================================= */
const restoreToggle = document.getElementById('restoreToggle');

function restoreOriginal(){
  const ok = confirm('Restore the original version? All your unsaved changes will be lost.');
  if(!ok) return;
  try{
    localStorage.removeItem('fcomEdits');
    localStorage.removeItem('customItems');
    localStorage.removeItem('userNotes');
  }catch(e){ console.error(e); }
  // Force a hard reload to re-run scripts & styles
  const url = new URL(window.location.href);
  url.searchParams.set('restored', '1');
  url.searchParams.set('ts', String(Date.now()));
  window.location.replace(url.toString());
}

if (restoreToggle){
  restoreToggle.addEventListener('click', restoreOriginal);
}



document.addEventListener('DOMContentLoaded', ()=>{
  const infoToggle = document.getElementById('infoToggle');
  const infoModal  = document.getElementById('infoModal');
  const closeInfo  = document.getElementById('closeInfo');

  if (infoToggle){
    infoToggle.addEventListener('click', ()=>{
      const m = document.getElementById('infoModal');
      m?.classList.add('show');
    });
  }
  if (closeInfo){
    closeInfo.addEventListener('click', ()=>{
      const m = document.getElementById('infoModal');
      m?.classList.remove('show');
    });
  }
  const m = document.getElementById('infoModal');
  if (m){
    m.addEventListener('click', (e)=>{
      if(e.target === m) m.classList.remove('show');
    });
  }
});


// === ESC Global Reset ===
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // Eğer modal açıksa, sadece modal kapanır
    if (modal?.classList.contains('show')) {
      closeDesc();
      return;
    }
    // Modal açık değilse: tüm checklist resetlensin
    document.querySelectorAll('.item').forEach(item => item.classList.remove('done','hidden'));
    document.querySelectorAll('.topic-box').forEach(topic => {
      topic.classList.remove('completed');
      checkCompletion(topic);
    });
  }
});


// === Keyboard Navigation with Arrow Keys ===
document.addEventListener('keydown', (e) => {
  if (e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;

  const items = Array.from(document.querySelectorAll('.item:not(.hidden)'));
  if (!items.length) return;

  // currently focused item (if any)
  const activeEl = document.activeElement && document.activeElement.closest ? document.activeElement.closest('.item') : null;
  let idx = items.indexOf(activeEl);
  if (idx === -1) {
    // no item focused yet: pick the first visible one
    idx = 0;
  } else {
    if (e.key === 'ArrowDown') {
      idx = Math.min(idx + 1, items.length - 1);
    } else if (e.key === 'ArrowUp') {
      idx = Math.max(idx - 1, 0);
    }
  }

  const nextItem = items[idx];
  if (nextItem) {
    try { nextItem.focus({preventScroll:true}); } catch(_){}
    nextItem.scrollIntoView({behavior:'smooth', block:'center'});
    e.preventDefault();
  }
});

</script>
<div aria-labelledby="infoTitle" aria-modal="true" class="modal" id="infoModal" role="dialog">
<div class="modal-card">
<div class="modal-header">
<div class="modal-title" id="infoTitle">How to Use This Checklist</div>
<button class="close-btn" id="closeInfo">×</button>
</div>
<div class="modal-body">
<ul>
<li>Click an item to mark it as completed. Completed items will hide automatically.</li>
<li>Click the "?" button next to an item to view detailed Item notes.</li>
<li>Use the <b>Reset</b> button to reset all items in that section.</li>
<li>Use the <b>Add Row</b> button to insert your own checklist items.</li>
<li><b>Delete items:</b> In the Item note window, you can delete the current item with <i>Delete Item</i>. Custom rows are removed permanently; default rows return if you restore the original file.</li>
<li><b>Edit explanations:</b> Click <i>Update Note</i> to edit the item note text, then <i>Save</i>.</li>
<li>Top-right buttons allow theme change (☀️/🌙), saving your edits (💾), and restoring defaults (⟲).</li>
<li>Your notes and changes are saved locally in your browser and included when you export the file.</li>
</ul>
</div>
</div>
</div>
<script>
// === Dual Edit: delegated & guaranteed apply ===
(function(){
  function $(s){ return document.querySelector(s); }
  function show(){ var ov=$('#dualEditOverlay'); if(ov) ov.style.display='flex'; }
  function hide(){ var ov=$('#dualEditOverlay'); if(ov) ov.style.display='none'; }

  function splitText(t){
    t=(t||'').trim();
    // split: take last token as right (ON/SET), rest left; ignore dotfill
    var m=t.match(/^(.*?)(?:\s*[.·•…‧⋯]*\s*)?(\S+)$/);
    return m ? [m[1].trim(), m[2].trim()] : [t,''];
  }
  function joinText(l,r){
    l=(l||'').trim(); r=(r||'').trim();
    return (l && r) ? (l+' '+r) : (l || r);
  }

  // Ensure modal exists even if CSS/HTML was stripped
  document.addEventListener('DOMContentLoaded', function(){
    if(!document.getElementById('dualEditOverlay')){
      var wrapper=document.createElement('div');
      wrapper.innerHTML = `<!-- Dual Edit Modal --><div id=\"dualEditOverlay\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"dualEditTitle\">  <div id=\"dualEditModal\">    <h4 id=\"dualEditTitle\">Edit item text</h4>    <div class=\"row\">      <div style=\"flex:1\">        <label>ITEM</label>        <input id=\"dualLeft\" type=\"text\" placeholder=\"EXTERNAL POWER\">      </div>      <div style=\"flex:1\">        <label>ACTION</label>        <input id=\"dualRight\" type=\"text\" placeholder=\"ON / SET\">      </div>    </div>    <div class=\"actions\">      <button id=\"dualEditOK\">Apply</button>      <button id=\"dualEditCancel\">Cancel</button>    </div>  </div></div>`;
      document.body.appendChild(wrapper.firstElementChild);
    }
  });

  // Stash previous text when opening editor (to find the right <p> later if currentItemEl yoksa)
  document.addEventListener('click', function(e){
    var btn=e.target && e.target.closest('#editItemBtn');
    if(!btn) return;
    var p = (window.currentItemEl && window.currentItemEl.querySelector)
            ? window.currentItemEl.querySelector('p') : null;
    var oldText = p ? (p.textContent||'').trim()
                    : (document.getElementById('descTitle') && document.getElementById('descTitle').textContent.trim()) || '';
    window.__dualOldText = oldText;

    // Open editor with split
    var leftI = document.getElementById('dualLeft');
    var rightI = document.getElementById('dualRight');
    if(!leftI || !rightI){ return; }
    var parts = splitText(oldText);
    leftI.value = ''; rightI.value = ''; leftI.placeholder = parts[0] || leftI.placeholder; rightI.placeholder = parts[1] || rightI.placeholder;
    show();
    setTimeout(function(){ leftI.focus(); leftI.select(); }, 0);
  }, true);

  // Apply save on OK / Enter; Cancel on Esc
  function applySave(saveIt){
    var leftI = document.getElementById('dualLeft');
    var rightI = document.getElementById('dualRight');
    if(!leftI || !rightI){ hide(); return; }
    if(!saveIt){ hide(); return; }

    var newCombined = joinText(leftI.value, rightI.value);

    // 1) Prefer currentItemEl
    var p = (window.currentItemEl && window.currentItemEl.querySelector) ? window.currentItemEl.querySelector('p') : null;
    if(!p){
      // 2) Fallback by matching old text
      var oldTxt = (window.__dualOldText||'').trim();
      var candidates = Array.prototype.slice.call(document.querySelectorAll('.topic-box p'));
      var hit = candidates.find(function(node){ return ((node.textContent||'').trim() === oldTxt); });
      p = hit || null;
    }
    if(p){
      p.textContent = newCombined;
      try{ window.buildLeaders && window.buildLeaders(); }catch(_){}
      try{
        var sec = p.closest('.topic-box');
        if(sec && window.checkCompletion) window.checkCompletion(sec);
      }catch(_){}
    }else{
      // 3) Last resort: modal header
      var t = document.getElementById('descTitle');
      if(t) t.textContent = newCombined;
    }
    hide();
  }

  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='dualEditOK'){ e.preventDefault(); applySave(true); }
    if(e.target && e.target.id==='dualEditCancel'){ e.preventDefault(); hide(); }
  });
  document.addEventListener('keydown', function(e){
    var ov = document.getElementById('dualEditOverlay');
    if(ov && ov.style.display==='flex'){
      if(e.key==='Escape'){ e.preventDefault(); hide(); }
      if(e.key==='Enter'){ e.preventDefault(); applySave(true); }
    }
  });
})();
</script>
<script>
(function ensureNotesSaveWorks(){
  // Determine current item id (data-note-id) or fallback to title text
  function q(sel,root){ return (root||document).querySelector(sel); }
  function currentButton(){
    var b = window.currentItemEl && window.currentItemEl.closest && window.currentItemEl.closest('button.item');
    if (!b) b = q('button.item[data-last-focus="1"]');
    return b;
  }
  function currentId(){
    var b = currentButton();
    return b ? (b.getAttribute('data-note-id') || b.id || '') : '';
  }
  var STORE = 'notesById_savefixV1';
  var db = {};
  try { var raw = localStorage.getItem(STORE); if (raw) db = JSON.parse(raw) || {}; } catch(_){}

  function saveDb(){ try { localStorage.setItem(STORE, JSON.stringify(db)); } catch(_){ } }

  // Mark last-focused item for accurate currentId()
  document.addEventListener('mousedown', function(e){
    var b = e.target && e.target.closest && e.target.closest('button.item');
    if (b){
      document.querySelectorAll('button.item[data-last-focus]').forEach(function(x){ x.removeAttribute('data-last-focus'); });
      b.setAttribute('data-last-focus','1');
      window.currentItemEl = b;
    }
  }, true);

  // Attach save handler (capture) that always runs
  document.addEventListener('click', function(e){
    var isSave = e.target && (e.target.id === 'saveEditBtn' || e.target.closest && e.target.closest('#saveEditBtn'));
    if (!isSave) return;
    var id = currentId();
    var body = q('#descBody') || q('#descModal textarea') || q('#descModal .modal-body');
    if (!body) return;
    var val = ('value' in body ? body.value : body.textContent || '').trim();
    if (!id){
      // fallback key: use title text hashed
      var title = q('#descTitle'); var key = (title && title.textContent.trim()) || 'global';
      id = 't:' + key;
    }
    db[id] = val;
    saveDb();
    // feedback: briefly flash the save button
    try{
      var btn = e.target.closest('#saveEditBtn') || e.target;
      var old = btn.textContent; btn.textContent = 'Saved';
      setTimeout(function(){ btn.textContent = old; }, 800);
    }catch(_){}
  }, true);
})();
</script>
<div aria-hidden="true" id="dualEditOverlay" style="display: none;"><div aria-modal="true" id="dualEditModal" role="dialog"><h4>Yeni Madde Ekle</h4><div class="row"><div style="flex:1"><label for="dualLeft">ITEM</label><input id="dualLeft" placeholder="Örn: SEAT BELTS" type="text" __gchrome_uniqueid="1"></div><div style="flex:1"><label for="dualRight">ACTION</label><input id="dualRight" placeholder="Örn: ON / CHECKED" type="text" __gchrome_uniqueid="2"></div></div><div class="actions"><button id="dualEditOK">Ekle</button><button id="dualEditCancel">İptal</button></div></div></div><script>
(function(){
  const d = document;
  let currentTopic = null;

  // Ensure buildLeaders runs for any statically existing lines after we add rows
  function ensureBuildLeaders(){
    try{
      if (typeof buildLeaders === 'function') buildLeaders();
    }catch(e){ /* ignore */ }
  }

  // Open/Close modal helpers
  const overlay = d.getElementById('dualEditOverlay');
  const okBtn   = d.getElementById('dualEditOK');
  const cancel  = d.getElementById('dualEditCancel');
  const leftInp = d.getElementById('dualLeft');
  const rightInp= d.getElementById('dualRight');
  const titleEl = d.querySelector('#dualEditModal h4');

  function openDual(topicEl, presetLeft="", presetRight=""){
    currentTopic = topicEl;
    if (titleEl) titleEl.textContent = "Yeni Madde Ekle";
    leftInp.value  = presetLeft || "";
    rightInp.value = presetRight || "";
    overlay.style.display = "flex";
    setTimeout(()=> leftInp.focus(), 50);
  }
  function closeDual(){
    overlay.style.display = "none";
    currentTopic = null;
    leftInp.value = "";
    rightInp.value = "";
  }

  // Hook ESC and backdrop
  overlay.addEventListener('click', (e)=>{
    if (e.target === overlay) closeDual();
  });
  d.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && overlay.style.display === 'flex') closeDual();
  });
  cancel.addEventListener('click', closeDual);

  // Create a new checklist item element
  function createItem(leftText, rightText){
    const btn = d.createElement('button');
    btn.className = 'item';
    const p = d.createElement('p');
    const L = (leftText || '').trim();
    const R = (rightText || '').trim();
    // Yazıyı düz metin olarak ver; buildLeaders ayırsın
    p.textContent = L ? (R ? (L + ' ....... ' + R) : L) : R;
    btn.appendChild(p);

    // dataset.key: kaydetme için anahtar (normalizeKey varsa onu kullan)
    try {
      if (typeof normalizeKey === 'function') {
        btn.dataset.key = normalizeKey(L || R || ('item_' + Math.floor(Math.random()*1e6)));
      } else {
        btn.dataset.key = (L || R || ('item_' + Math.floor(Math.random()*1e6))).toLowerCase().replace(/\s+/g,'_');
      }
    } catch(e){
      btn.dataset.key = (L || R || ('item_' + Math.floor(Math.random()*1e6))).toLowerCase().replace(/\s+/g,'_');
    }

    // ? butonu: mevcut akıştaki save için currentItemEl'ı set et ve openDesc'i dataset.key ile aç
    const info = d.createElement('span');
    info.className = 'info-btn'; info.setAttribute('role','button'); info.setAttribute('tabindex','0'); info.setAttribute('aria-label','Açıklamayı göster');
    info.textContent = '?';
    info.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      try { window.currentItemEl = btn; } catch(_){}
      try { if (typeof openDesc === 'function') openDesc(btn.dataset.key || (L || R) || 'Info'); } catch(_){}
    });
    btn.appendChild(info);
    return btn;
  });
    btn.appendChild(info);
    return btn;
  }

  // When OK is clicked, insert item just above the .actions container (so buttons stay at the bottom)
  okBtn.addEventListener('click', ()=>{
    const left  = (leftInp.value || '').trim();
    const right = (rightInp.value || '').trim();
    if (!currentTopic) return;
    if (!left) { leftInp.focus(); return; }
    // create and insert
    const newItem = createItem(left, right);
    // give a unique data-note-id
    const uniq = 'n' + Math.floor(1e6 + Math.random()*9e6);
    newItem.dataset.noteId = uniq;
    newItem.id = 'item-' + uniq;
    // Find actions footer
    const actions = currentTopic.querySelector('.actions');
    if (actions){
      currentTopic.insertBefore(newItem, actions);
    }else{
      currentTopic.appendChild(newItem);
    }
    // After inserting, (re)apply layout leaders if needed
    ensureBuildLeaders();
    closeDual();
    // brief focus flash
    newItem.classList.add('autoscroll-highlight');
    setTimeout(()=> newItem.classList.remove('autoscroll-highlight'), 1200);
    newItem.scrollIntoView({behavior:'smooth', block:'center'});
  });

  // Wire add-row buttons
  d.querySelectorAll('.topic-box .actions .add-row').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const topic = e.target.closest('.topic-box');
      openDual(topic);
    });
  });

  // If sections are dynamically added or class toggles change, keep leaders sane
  ensureBuildLeaders();
})();</script><script>
(function(){
  const d=document;
  const overlay = d.getElementById('dualEditOverlay');
  const leftInp = d.getElementById('dualLeft');
  const rightInp = d.getElementById('dualRight');
  const cancel = d.getElementById('dualEditCancel');
  const okBtn = d.getElementById('dualEditOK');
  let currentTopic = null;

  function ensureBuildLeaders(){
    try{ if (typeof buildLeaders==='function') buildLeaders(); }catch(_){}
  }
  function openDual(topicEl){
    currentTopic = topicEl;
    if (overlay){ overlay.style.display='flex'; setTimeout(()=> leftInp?.focus(), 30); }
  }
  function closeDual(){
    if (overlay){ overlay.style.display='none'; }
    currentTopic = null;
    if (leftInp) leftInp.value='';
    if (rightInp) rightInp.value='';
  }
  cancel?.addEventListener('click', closeDual);
  overlay?.addEventListener('click', (e)=>{ if (e.target===overlay) closeDual(); });
  d.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && overlay?.style.display==='flex') closeDual(); });

  // Delegated handler for any future .add-row button
  d.addEventListener('click', (e)=>{
    const btn = e.target.closest('.add-row');
    if (btn){
      const topic = btn.closest('.topic-box') || d.body;
      openDual(topic);
    }
  });

  // Insert on OK
  okBtn?.addEventListener('click', ()=>{
    const L = (leftInp?.value || '').trim();
    const R = (rightInp?.value || '').trim();
    if (!currentTopic || !L) { leftInp?.focus(); return; }
    const newBtn = d.createElement('button');
    newBtn.className='item';
    const p = d.createElement('p');
    p.textContent = L + (R?(' ....... '+R):'');
    newBtn.appendChild(p);
    // key for notes
    try{
      newBtn.dataset.key = typeof normalizeKey==='function' ? normalizeKey(L || R) : (L||R).toLowerCase().replace(/\s+/g,'_');
    }catch(_){
      newBtn.dataset.key = (L||R).toLowerCase().replace(/\s+/g,'_');
    }
    // info button
    const info = d.createElement('span'); info.className='info-btn'; info.textContent='?'; info.setAttribute('role','button'); info.setAttribute('tabindex','0'); info.setAttribute('aria-label','Açıklamayı göster');
    info.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      try{ window.currentItemEl = newBtn; }catch(_){}
      try{ if (typeof openDesc==='function') openDesc(newBtn.dataset.key || (L||R) || 'Info'); }catch(_){}
    });
    newBtn.appendChild(info);

    const actions = currentTopic.querySelector('.actions');
    if (actions){ currentTopic.insertBefore(newBtn, actions); } else { currentTopic.appendChild(newBtn); }
    ensureBuildLeaders();
    closeDual();
    newBtn.classList.add('autoscroll-highlight');
    setTimeout(()=> newBtn.classList.remove('autoscroll-highlight'), 1000);
    newBtn.scrollIntoView({behavior:'smooth', block:'center'});
  });
})();</script>


<script>
(function editableHeadings(){
  function makeIconButton(label, title){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'title-edit-btn';
    b.setAttribute('aria-label', label);
    b.title = title || label;
    b.textContent = '🖊️';
    return b;
  }
  const STORE_KEY = 'titleEdits';
  let titleEdits = {};
  try { const raw = localStorage.getItem(STORE_KEY); if (raw) titleEdits = JSON.parse(raw); } catch(_) {}
  const saveTitles = () => { try { localStorage.setItem(STORE_KEY, JSON.stringify(titleEdits)); } catch(_) {} };

  function enableEditing(hEl, key, onSaved){
    const original = hEl.textContent.trim();
    hEl.setAttribute('contenteditable','true');
    hEl.focus();
    const range = document.createRange();
    range.selectNodeContents(hEl);
    const sel = window.getSelection();
    sel.removeAllRanges(); sel.addRange(range);
    const finish = (save) => {
      hEl.setAttribute('contenteditable','false');
      hEl.removeEventListener('keydown', onKey);
      hEl.removeEventListener('blur', onBlur);
      const newVal = hEl.textContent.trim() || original;
      if (!save) hEl.textContent = original;
      if (save && newVal !== original){
        titleEdits[key] = newVal; saveTitles(); onSaved?.(newVal);
      } else { onSaved?.(hEl.textContent.trim()); }
    };
    const onKey = (e) => {
      if (e.key === 'Enter'){ e.preventDefault(); finish(true); }
      else if (e.key === 'Escape'){ e.preventDefault(); finish(false); }
    };
    const onBlur = () => finish(true);
    hEl.addEventListener('keydown', onKey);
    hEl.addEventListener('blur', onBlur);
  }

  const style = document.createElement('style');
  style.textContent = `
    .title-edit-wrap{ display:inline-flex; align-items:center; gap:8px; }
    .title-edit-btn{ 
/* Başlık ortalama */
.topic-box h2 {
  text-align: center;
  width: 100%;
}

/* Düzenleme butonu stil: kare çerçeve içinde ortalanmış dolma kalem */
.title-edit-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px !important;
  width: 32px !important;
  height: 32px !important;
  border: 2px solid currentColor !important;
  border-radius: 6px !important;
  background: transparent !important;
}

      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);
      color:inherit; cursor:pointer;
      width:28px; height:28px; border-radius:8px;
      font-size:14px; line-height:1;
    }
    .title-edit-btn:hover{ background:rgba(255,255,255,.18); }
    body.light .title-edit-btn{ 
/* Başlık ortalama */
.topic-box h2 {
  text-align: center;
  width: 100%;
}

/* Düzenleme butonu stil: kare çerçeve içinde ortalanmış dolma kalem */
.title-edit-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px !important;
  width: 32px !important;
  height: 32px !important;
  border: 2px solid currentColor !important;
  border-radius: 6px !important;
  background: transparent !important;
}

      border-color: rgba(0,0,0,.2);
      background: rgba(0,0,0,.06);
    }
    body.light .title-edit-btn:hover{ background: rgba(0,0,0,.14); }
  `;
  document.head.appendChild(style);

  // ANA BAŞLIK (h3#globalReset) – varsa düzenlenebilir yap
  const mainH = document.getElementById('globalReset');
  if (mainH){
    const key = 'globalTitle';
    if (titleEdits[key]) mainH.textContent = titleEdits[key];
    const wrap = document.createElement('span');
    wrap.className = 'title-edit-wrap';
    wrap.id = 'globalResetWrap';
    mainH.replaceWith(wrap);
    wrap.appendChild(mainH);
    const btn = makeIconButton('Başlığı düzenle', 'Başlığı düzenle');
    btn.addEventListener('click', () => enableEditing(mainH, key));
    wrap.appendChild(btn);
  }

  // BÖLÜM BAŞLIKLARI (.topic-box > h2)
  document.querySelectorAll('.topic-box').forEach(section => {
    const h2 = section.querySelector('h2');
    if (!h2) return;
    const secKey = section.id ? `h2:${section.id}` : `h2:${h2.textContent.trim()}`;
    if (titleEdits[secKey]) {
      h2.textContent = titleEdits[secKey];
      section.setAttribute('aria-label', titleEdits[secKey]);
    }
    const wrap = document.createElement('div');
    wrap.className = 'title-edit-wrap';
    h2.replaceWith(wrap);
    wrap.appendChild(h2);
    const btn = makeIconButton('Bölüm başlığını düzenle', 'Bölüm başlığını düzenle');
    btn.addEventListener('click', () => enableEditing(h2, secKey, (newTitle)=>{
      section.setAttribute('aria-label', newTitle);
      if (!section.dataset.titleKey) {
        section.dataset.titleKey = (section.getAttribute('aria-label') || newTitle);
      }
    }));
    wrap.appendChild(btn);
  });

  // Export fonksiyonu varsa başlıkları gömme
  if (typeof exportToHtml === 'function') {
    const _orig = exportToHtml;
    window.exportToHtml = function(){
      try {
        const edits = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
        Object.entries(edits).forEach(([k, v])=>{
          if (k === 'globalTitle'){
            const el = document.getElementById('globalReset');
            if (el) el.textContent = v;
          } else if (k.startsWith('h2:')){
            const id = k.slice(3);
            const sec = document.getElementById(id);
            if (sec){
              const h2 = sec.querySelector('h2');
              if (h2) h2.textContent = v;
              sec.setAttribute('aria-label', v);
            }
          }
        });
      } catch(_) {}
      return _orig();
    };
  }
})();
</script>
<script>
(function finalDualEditFix(){
  // 1) Track the last clicked row inside any topic box
  document.addEventListener('mousedown', function(e){
    var row = e.target && (e.target.closest('.item') || e.target.closest('li') || e.target.closest('.row') || e.target.closest('.check-row'));
    if(row && row.closest('.topic-box')){
      window.currentItemEl = row;
    }
  }, true);

  function $(s){ return document.querySelector(s); }
  function show(){ var ov=$('#dualEditOverlay'); if(ov){ ov.style.display='flex'; } }
  function hide(){ var ov=$('#dualEditOverlay'); if(ov){ ov.style.display='none'; } }

  function splitText(t){
    t=(t||'').trim();
    var m=t.match(/^(.*?)(?:\s*[.·•…‧⋯]*\s*)?(\S+)$/);
    return m ? [m[1].trim(), m[2].trim()] : [t,''];
  }
  function joinText(l,r){
    l=(l||'').trim(); r=(r||'').trim();
    return (l && r) ? (l+' '+r) : (l || r);
  }

  // 2) Only handle clicks on the dedicated edit button; don't block others (like ? / FCOM)
  function getEditBtn(){
    return document.getElementById('editItemBtn') || document.querySelector('#fcomModal .edit-item-btn, .edit-item-btn, #editItem');
  }
  function getItemTextNode(el){
    if(!el) return null;
    return el.querySelector('p, .item-text, .text, .desc, .content, span') || null;
  }

  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#editItemBtn, .edit-item-btn, #editItem');
    if(!btn) return;
    // We intercept ONLY the edit button; do not touch other buttons (like FCOM '?')
    e.preventDefault();
    e.stopPropagation(); // not 'immediate' to avoid breaking other bubbling listeners unnecessarily

    var pNode = (window.currentItemEl && getItemTextNode(window.currentItemEl)) || null;
    var oldText = pNode ? (pNode.textContent||'').trim()
                : (document.getElementById('descTitle') && document.getElementById('descTitle').textContent.trim()) || '';

    var parts = splitText(oldText);
    var leftI = document.getElementById('dualLeft');
    var rightI = document.getElementById('dualRight');
    if(!leftI || !rightI){ return; }
    leftI.value = ''; rightI.value = ''; leftI.placeholder = parts[0] || leftI.placeholder; rightI.placeholder = parts[1] || rightI.placeholder;
    // remember for fallback
    window.__dualOldText = oldText;
    window.__lastEditBtn = btn;
    show();
    setTimeout(function(){ leftI.focus(); leftI.select(); }, 0);
  }, true);

  function applySave(saveIt){
    var leftI = document.getElementById('dualLeft');
    var rightI = document.getElementById('dualRight');
    if(!leftI || !rightI){ hide(); return; }
    if(!saveIt){ hide(); if(window.__lastEditBtn){ try{ window.__lastEditBtn.focus(); }catch(_){}} return; }

    var newCombined = joinText(leftI.value, rightI.value);

    var p = (window.currentItemEl && getItemTextNode(window.currentItemEl)) || null;
    if(!p){
      var oldTxt = (window.__dualOldText||'').trim();
      var candidates = Array.prototype.slice.call(document.querySelectorAll('.topic-box p, .topic-box .item-text, .topic-box .text, .topic-box .desc, .topic-box .content, .topic-box li span'));
      var hit = candidates.find(function(node){ return ((node.textContent||'').trim() === oldTxt); });
      p = hit || null;
    }
    if(p){
      p.textContent = newCombined;
      try{ window.buildLeaders && window.buildLeaders(); }catch(_){}
      try{
        var sec = p.closest('.topic-box');
        if(sec && window.checkCompletion) window.checkCompletion(sec);
      }catch(_){}
    } else {
      var t = document.getElementById('descTitle');
      if(t) t.textContent = newCombined;
    }
    hide();
    // restore focus so other UI (like FCOM '?') continues to work
    if(window.__lastEditBtn){ try{ window.__lastEditBtn.focus(); }catch(_){}} 
  }

  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='dualEditOK'){ e.preventDefault(); applySave(true); }
    if(e.target && e.target.id==='dualEditCancel'){ e.preventDefault(); applySave(false); }
  });
  document.addEventListener('keydown', function(e){
    var ov = document.getElementById('dualEditOverlay');
    if(ov && ov.style.display==='flex'){
      if(e.key==='Escape'){ e.preventDefault(); applySave(false); }
      if(e.key==='Enter'){ e.preventDefault(); applySave(true); }
    }
  });

  // Ensure overlay is hidden initially to avoid blocking other modals
  document.addEventListener('DOMContentLoaded', function(){
    hide();
  });
})();
</script>


<!-- === Safe buildLeaders override to prevent first-item corruption & duplicate '?' === -->
<script>
(function(){
  // Generate a stable unique id for items lacking data-note-id
  function ensureNoteId(itemEl){
    if (!itemEl) return;
    if (!itemEl.dataset.noteId){
      var uniq = 'n' + Math.floor(Math.random()*1e9);
      itemEl.dataset.noteId = uniq;
      if (!itemEl.id) itemEl.id = 'item-' + uniq;
    }
  }

  // Override buildLeaders with an idempotent version
  window.buildLeaders = function(){
    document.querySelectorAll('.item p').forEach(function(p){
      var itemEl = p.closest('.item');
      if (!itemEl) return;

      // Source text: prefer preserved data-raw; else reconstruct from .l/.r; else current textContent
      var source = p.getAttribute('data-raw');
      if (!source){
        var lSpan = p.querySelector('.l');
        var rSpan = p.querySelector('.r');
        if (lSpan || rSpan){
          source = ((lSpan?lSpan.textContent:'') + ' ' + (rSpan?rSpan.textContent:''));
        } else {
          source = (p.textContent || '');
        }
        source = source.replace(/\s+/g,' ').trim();
        p.setAttribute('data-raw', source);
      }

      var raw = (source || '').replace(/\s+/g,' ').trim();
      var left = '', right = '';

      // 1) manual split with 2+ spaces
      var manual = source.match(/^(.*?)\s{2,}(.*)$/);
      if (manual){
        left = manual[1].trim(); right = manual[2].trim();
      } else {
        // 2) dotted/space leader
        var m = raw.match(/^(.*?)[.\s]{4,}(.*)$/);
        if (m){ left = m[1].trim(); right = m[2].trim(); }
        else {
          // 3) fallback: last token to right
          var parts = raw.split(' ');
          right = parts.pop() || '';
          left  = parts.join(' ');
        }
      }

      // Write structured HTML fresh each time
      p.innerHTML = ''
        + '<span class="l">' + left + '</span>'
        + '<span class="dotfill" aria-hidden="true"></span>'
        + '<span class="r">' + right + '</span>';

      // Ensure each item has exactly ONE info button, bound to data-note-id
      if (!itemEl.classList.contains('no-info')){
        // Assign a note id if missing (covers some custom-added rows)
        ensureNoteId(itemEl);
        // Remove any existing '?' to avoid duplicates
        var prev = itemEl.querySelectorAll('.info-btn');
        prev.forEach(function(x){ x.remove(); });
        // Add a single info button
        var info = document.createElement('span');
        info.className = 'info-btn';
        info.setAttribute('role','button');
        info.setAttribute('tabindex','0');
        info.setAttribute('aria-label','Açıklamayı göster');
        info.textContent = '?';
        info.addEventListener('click', function(ev){
          ev.stopPropagation();
          try{ window.currentItemEl = itemEl; }catch(_){}
          if (typeof openDesc === 'function'){
            openDesc(itemEl.dataset.noteId);
          }
        });
        info.addEventListener('keydown', function(ev){
          if (ev.key === 'Enter' || ev.key === ' '){
            ev.preventDefault(); ev.stopPropagation();
            try{ window.currentItemEl = itemEl; }catch(_){}
            if (typeof openDesc === 'function'){
              openDesc(itemEl.dataset.noteId);
            }
          }
        });
        itemEl.appendChild(info);
      }
    });
  };

  // Run once now to sanitize any duplicates created earlier
  try { window.buildLeaders(); } catch(e){ console.error(e); }
})();
</script>
</body></html>